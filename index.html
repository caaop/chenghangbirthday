<!DOCTYPE html>
<html lang="zh-CN">
<head>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#111111">

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Winter Gelato Shop - GameBoy Edition</title>
    <style>
        /* =========================================
           1. GameBoy å¤–å£³æ ·å¼ (ä¿æŒä¸å˜)
           ========================================= */
        :root {
            --gb-body: #c0c6c8;
            --gb-screen-lens: #545963;
            --gb-screen-bg: #111; /* æ”¹æˆæ·±è‰²èƒŒæ™¯é€‚é…ä½ çš„æ¸¸æˆ */
            --gb-btn-red: #8f1338;
            --gb-btn-dark: #272a2e;
            --pixel-font: 'Courier New', Courier, monospace;
        }

        * {
            box-sizing: border-box;
            user-select: none;
            -webkit-user-select: none;
            -webkit-touch-callout: none;
        }

        body {
            margin: 0; padding: 0;
            background-color: #111;
            height: 100vh; width: 100vw;
            overflow: hidden;
            display: flex; justify-content: center; align-items: center;
            font-family: var(--pixel-font);
        }

        #gameboy-container {
            position: relative;
            width: 320px; height: 540px;
            background-color: var(--gb-body);
            border-radius: 10px 10px 40px 10px;
            box-shadow: inset 3px 3px 5px rgba(255,255,255,0.4), inset -3px -3px 5px rgba(0,0,0,0.1), 0 0 20px rgba(0,0,0,0.5);
            display: flex; flex-direction: column; align-items: center;
            padding-top: 25px;
            transform-origin: center center;
            will-change: transform;
        }

        .top-grooves {
            position: absolute; top: 10px; width: 90%; height: 5px;
            border-top: 2px solid rgba(0,0,0,0.05); border-bottom: 2px solid rgba(0,0,0,0.05); left: 5%;
        }

        .screen-lens {
  background: linear-gradient(135deg, var(--gb-screen-lens) 0%, #686d79 50%, var(--gb-screen-lens) 100%);
    overflow: hidden; /* é˜²æ­¢åå…‰æº¢å‡º */
            width: 280px; height: 220px; /* ç¨å¾®åŠ é«˜ä»¥å®¹çº³ä½ çš„ 200x150 ç”»é¢ */
            background-color: var(--gb-screen-lens);
            border-radius: 10px 10px 30px 10px;
            position: relative;
            display: flex; justify-content: center;
            padding-top: 25px;
            box-shadow: inset 2px 2px 5px rgba(0,0,0,0.3);
        }
/* å¯ä»¥åœ¨ lens ä¸ŠåŠ ä¸€ä¸ªæ›´æ˜æ˜¾çš„é«˜å…‰æ¡ */
.screen-lens::before {
    content: "";
    position: absolute;
    top: -50%; left: -50%;
    width: 200%; height: 200%;
    background: linear-gradient(to bottom right, rgba(255,255,255,0) 40%, rgba(255,255,255,0.1) 50%, rgba(255,255,255,0) 60%);
    pointer-events: none;
}

/* 2. æœºèº«å¢åŠ æ›´æ·±çš„ç«‹ä½“æŠ•å½± */
#gameboy-container {
    /* ...åŸæœ‰å±æ€§... */
    /* ä¼˜åŒ–æŠ•å½±ï¼Œä½¿å…¶çœ‹èµ·æ¥æ›´åšé‡ */
    box-shadow: 
        inset 4px 4px 10px rgba(255,255,255,0.5), /* å·¦ä¸Šé«˜å…‰ */
        inset -4px -4px 10px rgba(0,0,0,0.2),    /* å³ä¸‹å†…é˜´å½± */
        5px 10px 25px rgba(0,0,0,0.6);           /* å¤–éƒ¨è½åœ°å½± */
}

        .lens-strip {
            position: absolute; top: 10px; width: 90%; display: flex; justify-content: space-between; align-items: center;
            color: #7d8087; font-size: 8px; font-weight: bold;
            border-top: 1px solid #7d8087; border-bottom: 1px solid #7d8087; padding: 1px 0;
        }

        .battery-led {
            position: absolute; top: 65px; left: 10px; width: 8px; height: 8px;
            background-color: #f00; border-radius: 50%; box-shadow: 0 0 5px #f00;
        }
        .battery-text {
            position: absolute; top: 78px; left: 3px; font-size: 8px; color: #999;
        }

        /* * æ ¸å¿ƒæ˜¾ç¤ºåŒºåŸŸï¼šè°ƒæ•´ä¸ºé€‚åº”ä½ çš„æ¸¸æˆå°ºå¯¸ (200x150)
         */
        .game-display {
            width: 200px;
            height: 150px;
            background-color: var(--gb-screen-bg);
            box-shadow: inset 2px 2px 5px rgba(0,0,0,0.6);
            image-rendering: pixelated; 
            image-rendering: crisp-edges;
            overflow: hidden;
            position: relative;
        }

        .brand-logo {
            margin-top: 10px; margin-left: -120px; color: #303285; font-weight: 900; font-style: italic; font-size: 18px; letter-spacing: 1px; text-shadow: 1px 1px 0px rgba(255,255,255,0.5);
        }
        .brand-logo span { font-weight: normal; font-size: 14px; color: #303285; }

        .controls-area { width: 100%; height: 240px; position: relative; }
        .btn-active { transform: translate(1px, 1px) !important; box-shadow: inset 1px 1px 3px rgba(0,0,0,0.5) !important; }

        .d-pad { position: absolute; top: 40px; left: 30px; width: 90px; height: 90px; }
        .cross-h, .cross-v { background-color: var(--gb-btn-dark); position: absolute; border-radius: 3px; box-shadow: 2px 2px 0px rgba(0,0,0,0.2), inset 1px 1px 2px rgba(255,255,255,0.2); }
        .cross-h { top: 30px; left: 0; width: 90px; height: 30px; }
        .cross-v { top: 0; left: 30px; width: 30px; height: 90px; }
        .cross-center { position: absolute; top: 35px; left: 35px; width: 20px; height: 20px; background: radial-gradient(circle, #222 20%, transparent 30%); z-index: 2; }

        .zone { position: absolute; z-index: 10; }
        .zone-up    { top: 0; left: 30px; width: 30px; height: 40px; }
        .zone-down  { bottom: 0; left: 30px; width: 30px; height: 40px; }
        .zone-left  { top: 30px; left: 0; width: 40px; height: 30px; }
        .zone-right { top: 30px; right: 0; width: 40px; height: 30px; }

        .action-btns { position: absolute; top: 50px; right: 20px; width: 110px; height: 60px; transform: rotate(-25deg); }
        .ab-btn { width: 36px; height: 36px; background-color: var(--gb-btn-red); border-radius: 50%; position: absolute; box-shadow: 2px 2px 3px rgba(0,0,0,0.3), inset -1px -1px 3px rgba(0,0,0,0.2); }
        .ab-btn::after { content: attr(data-label); position: absolute; bottom: -18px; right: 8px; font-size: 12px; color: #303285; font-weight: bold; font-family: sans-serif; transform: rotate(25deg); }
        .btn-a { right: 0; top: 5px; }
        .btn-b { left: 10px; bottom: 5px; }

        .option-btns { position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); display: flex; gap: 15px; }
        .pill-btn-wrapper { display: flex; flex-direction: column; align-items: center; }
        .pill-btn { width: 50px; height: 12px; background-color: #999; border-radius: 10px; transform: rotate(-25deg); box-shadow: 1px 1px 2px rgba(0,0,0,0.3); margin-bottom: 5px; border: 1px solid rgba(0,0,0,0.1); }
        .pill-label { font-size: 8px; color: #303285; font-weight: bold; font-family: sans-serif; letter-spacing: 0.5px; margin-top: 5px; }

        .speaker { position: absolute; bottom: 25px; right: 20px; transform: rotate(-25deg); }
        .speaker-slot { width: 60px; height: 6px; background-color: rgba(0,0,0,0.1); margin-bottom: 4px; border-radius: 3px; box-shadow: inset 1px 1px 1px rgba(0,0,0,0.2); }

        /* =========================================
           2. ä½ çš„æ¸¸æˆç‰¹å®šæ ·å¼ (ç§»æ¤è‡ªå°æ¸¸æˆ.txt)
           ========================================= */
        canvas {
            display: block; /* ç§»é™¤é»˜è®¤å†…è¾¹è· */
            width: 100%;    /* å¡«æ»¡å®¹å™¨ */
            height: 100%;
        }

        .ui-layer {
            position: absolute;
            top: 5px; left: 5px; /* è°ƒæ•´ä½ç½®ä»¥é€‚åº”å°å±å¹• */
            pointer-events: none;
            display: flex; flex-direction: column; gap: 2px;
        }
        /* å°æ ‡ç­¾ï¼šé™ä½é€æ˜åº¦ï¼Œç¼©å°å­—ä½“ */
.tag {
    background: rgba(0,0,0,0.35);
    padding: 2px 4px;
    border-radius: 2px;
    color: #fff;
    font-size: 8px; /* ç”± 10px é™åˆ° 8px */
    border-left: 2px solid #FFD54F;
    text-shadow: 1px 1px 0 #000;
    font-weight: normal;
    font-family: 'Courier New', monospace;
}

        #click-to-start {
            position: absolute; top:0; left:0; width:100%; height:100%;
            background: rgba(0,0,0,0.85); color:#fff; display: flex;
            justify-content: center; align-items: center; 
            font-size: 14px; /* å­—ä½“æ”¹å° */
            text-align: center;
            z-index: 99; cursor: pointer;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
            padding: 20px;
        }
    </style>
</head>
<body>

    <div id="gameboy-container">
        <div class="top-grooves"></div>

        <div class="screen-lens">
            <div class="lens-strip">
                <span> </span>
            </div>
            
            <div class="battery-led"></div>
            <div class="battery-text">BATTERY</div>

            <div class="game-display" id="game-display">
                <canvas id="gameCanvas" width="200" height="150"></canvas>
 
                  </div>
        </div>

        <div class="brand-logo">Spoon Gelato</span>&trade;</div>

        <div class="controls-area">
            <div class="d-pad">
                <div class="cross-v"></div>
                <div class="cross-h"></div>
                <div class="cross-center"></div>
                <div class="zone zone-up"    data-key="ArrowUp"></div>
                <div class="zone zone-down"  data-key="ArrowDown"></div>
                <div class="zone zone-left"  data-key="ArrowLeft"></div>
                <div class="zone zone-right" data-key="ArrowRight"></div>
            </div>

            <div class="action-btns">
                <div class="ab-btn btn-b" data-label="B" data-key="z"></div>
                <div class="ab-btn btn-a" data-label="A" data-key=" "></div> 
            </div>

            <div class="option-btns">
                <div class="pill-btn-wrapper">
                    <div class="pill-btn" data-key="Shift"></div> <span class="pill-label">SELECT</span>
                </div>
                <div class="pill-btn-wrapper">
                    <div class="pill-btn" data-key="Enter"></div> <span class="pill-label">START</span>
                </div>
            </div>

            <div class="speaker">
                <div class="speaker-slot"></div><div class="speaker-slot"></div><div class="speaker-slot"></div>
                <div class="speaker-slot"></div><div class="speaker-slot"></div><div class="speaker-slot"></div>
            </div>
        </div>
    </div>

<script>

    /* =========================================
       1. ä½ çš„æ¸¸æˆé€»è¾‘ (å·²ç§»æ¤å¹¶ä¿®æ”¹æŒ‰é”®ç›‘å¬)
       ========================================= */
// ================== ç³»ç»Ÿå¯åŠ¨çŠ¶æ€æœº ==================
const SYSTEM = {
  state: 'LOGO',   // LOGO â†’ TITLE â†’ GAME
  timer: 0,

  // Logo åŠ¨ç”»å‚æ•°
  logoY: -40,
  logoVy: 0,
  logoLanded: false,

  blink: 0,
  titleScrollY: 0
};

    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    ctx.imageSmoothingEnabled = false;

    // --- 0. éŸ³é¢‘ç³»ç»Ÿ ---
    let audioCtx = null;
    let audioStarted = false;
    let musicInterval = null;
let bgmInterval = null;
let bgmPlaying = false;
let titleSnowflakes = Array.from({ length: 25 }, () => ({
  x: Math.random() * 200,
  y: Math.random() * 150,
  speed: Math.random() * 0.3 + 0.1
}));

function start8BitBGM() {
  if (!audioCtx || bgmPlaying) return;
  bgmPlaying = true;

  // === å†¬æ—¥ä¸»æ—‹å¾‹ï¼ˆä½å…«åº¦ï¼Œtriangleï¼‰===
  const melody = [
    { f: 196, d: 0.6 }, // G3
    { f: 220, d: 0.6 }, // A3
    { f: 196, d: 0.6 }, // G3
    { f: 165, d: 0.8 }, // E3

    { f: 175, d: 0.6 }, // F3
    { f: 196, d: 1.0 }, // G3

    { f: 147, d: 0.8 }, // D3
    { f: 165, d: 0.6 }, // E3
    { f: 175, d: 0.6 }, // F3
    { f: 196, d: 1.2 }, // G3
  ];

  // === æè½»çš„å‘¼å¸å¼é«˜éŸ³ç‚¹ç¼€ï¼ˆsquareï¼Œä½éŸ³é‡ï¼‰===
  const sparkle = [
    { f: 523, d: 0.15 },
    { f: 587, d: 0.15 },
  ];

  let total = melody.reduce((s, n) => s + n.d + 0.15, 0);

  const playLoop = () => {
    let t = 0;

    // ä¸»æ—‹å¾‹
    melody.forEach(n => {
      setTimeout(() => {
        if (bgmPlaying) {
          playTone(n.f, n.d, 'triangle', 0.05);
        }
      }, t * 1000);
      t += n.d + 0.15;
    });

    // å†¬æ—¥â€œç©ºæ°”æ„Ÿâ€ç‚¹ç¼€ï¼ˆéå¸¸è½»ï¼‰
    sparkle.forEach((n, i) => {
      setTimeout(() => {
        if (bgmPlaying) {
          playTone(n.f, n.d, 'square', 0.02);
        }
      }, (total - 1.2 + i * 0.6) * 1000);
    });
  };
    // =========================================
    // ã€æ–°å¢ã€‘ç‚¹å‡»çª—æˆ·è§¦å‘èµé›ªæ¨¡å¼
    // =========================================
    canvas.addEventListener('mousedown', (e) => {
        // 1. è·å– Canvas åœ¨å±å¹•ä¸Šçš„å®é™…ä½ç½®å’Œç¼©æ”¾æ¯”ä¾‹
        const rect = canvas.getBoundingClientRect();
        
        // æ¸¸æˆå†…éƒ¨åˆ†è¾¨ç‡æ˜¯ 200x150
        const scaleX = 200 / rect.width;
        const scaleY = 150 / rect.height;

        // 2. è®¡ç®—ç‚¹å‡»åœ¨æ¸¸æˆç”»é¢å†…çš„åæ ‡ (x, y)
        const clickX = (e.clientX - rect.left) * scaleX;
        const clickY = (e.clientY - rect.top) * scaleY;

        // 3. åˆ¤æ–­æ˜¯å¦ç‚¹ä¸­äº†çª—æˆ·åŒºåŸŸ (SCENE.window)
        // SCENE.window å®šä¹‰ä¸º { x: 50, y: 5, w: 100, h: 20 }
        // æ³¨æ„ï¼šç”±äº update é‡Œå¯èƒ½ä¼šåŠ¨æ€ä¿®æ”¹ SCENEï¼Œè¿™é‡Œç›´æ¥ç”¨ SCENE.window å˜é‡
        const win = SCENE.window;
        
        if (clickX >= win.x && clickX <= win.x + win.w &&
            clickY >= win.y && clickY <= win.y + win.h) {
            
            // è§¦å‘æ•ˆæœï¼šå¢åŠ é›ªèŠ±å¯†åº¦
            if (GAME.snowTarget < 50) { // é˜²æ­¢é‡å¤ç‚¹å‡»
                GAME.snowTarget = 80; // ç›®æ ‡å¯†åº¦è®¾ä¸º 120 (å¤§é›ª)
                
                // ç»™ä¸ªæç¤ºæ–‡å­—
                GAME.toast.text = "é›ªçªç„¶å˜å¤§äº† ...";
                GAME.toast.timer = 80; // æ˜¾ç¤º 2 ç§’
                
                // æ’­æ”¾ä¸€ä¸ªéŸ³æ•ˆ (åˆ©ç”¨ä½ ç°æœ‰çš„å‡½æ•°)
                if(typeof playTone === 'function') {
                    playTone(800, 0.1, 'triangle', 0.05);
                    setTimeout(() => playTone(600, 0.2, 'triangle', 0.05), 100);
                }

                // 5ç§’åæ¢å¤æ­£å¸¸
                setTimeout(() => {
                    GAME.snowTarget = 10; // æ¢å¤åˆ° 10
                    GAME.toast.text = "é›ªåœäº† ...";
                    GAME.toast.timer = 60;
                }, 5000);
            }
        }
    });

    // è¿™ä¸€è¡Œæ˜¯ä½ åŸæ–‡ä»¶çš„ç»“å°¾
    // loop(); 

  playLoop();
  bgmInterval = setInterval(playLoop, total * 1000);
}

function stop8BitBGM() {
  bgmPlaying = false;
  if (bgmInterval) {
    clearInterval(bgmInterval);
    bgmInterval = null;
  }
}

function drawVerticalScanlines(intensity = 0.15, spacing = 2) {
  ctx.fillStyle = `rgba(0,0,0,${intensity})`;
  for (let x = 0; x < 200; x += spacing) {
    ctx.fillRect(x, 0, 1, 150);
  }
}

    function initAudio() {
  if (audioStarted) return;
  audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  audioStarted = true;

  // ç‚¹äº®ç”µæºç¯ï¼ˆè¿™ä¸€æ­¥ä¿ç•™ï¼Œéå¸¸ GameBoyï¼‰
  const led = document.querySelector('.battery-led');
  led.style.boxShadow = "0 0 5px #4AFD03";
  led.style.backgroundColor = "#4AFD03";
}

function playBootClick() {
  if (!audioCtx) return;

  // â€œå’”â€
  playTone(420, 0.05, 'square', 0.2);
  // â€œå“’â€
  setTimeout(() => playTone(260, 0.08, 'square', 0.15), 60);
}

    function playTone(freq, duration, type='square', vol=0.1) {
        if (!audioCtx) return;
        const oscillator = audioCtx.createOscillator();
        const gainNode = audioCtx.createGain();
        oscillator.type = type;
        oscillator.frequency.setValueAtTime(freq, audioCtx.currentTime);
        gainNode.gain.setValueAtTime(vol, audioCtx.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration);
        oscillator.connect(gainNode);
        gainNode.connect(audioCtx.destination);
        oscillator.start();
        oscillator.stop(audioCtx.currentTime + duration);
    }

    function playJingle() {
        playTone(880, 0.1); setTimeout(() => playTone(1760, 0.2), 100);
    }

    function playShutterSound() {
        if (!audioCtx) return;
        const bufferSize = audioCtx.sampleRate * 0.1; 
        const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
        const data = buffer.getChannelData(0);
        for (let i = 0; i < bufferSize; i++) data[i] = Math.random() * 2 - 1;
        const noise = audioCtx.createBufferSource();
        noise.buffer = buffer;
        const gain = audioCtx.createGain();
        gain.gain.setValueAtTime(0.5, audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
        noise.connect(gain);
        gain.connect(audioCtx.destination);
        noise.start();
    }
    function playJingle() {
        playTone(880, 0.1); setTimeout(() => playTone(1760, 0.2), 100);
    }

    // [æ–°å¢] èƒœåˆ©æ—¶çš„æ€¥ä¿ƒä¸Šè¡ŒéŸ³é˜¶
    function playWinArpeggio() {
        if (!audioCtx) return;
        // å¿«é€Ÿæ’­æ”¾ C Major ä¸Šè¡Œ (C5, E5, G5, C6)
        const notes = [523.25, 659.25, 783.99, 1046.50]; 
        notes.forEach((freq, i) => {
            setTimeout(() => {
                playTone(freq, 0.1, 'square', 0.15);
            }, i * 60); // é—´éš”60msï¼Œéå¸¸æ€¥ä¿ƒ
        });
    }
function playTextBeep() {
  if (!audioCtx) return;

  // 10% æ¦‚ç‡ä¸å“ï¼ˆGameBoy ä¼šâ€œæ¼éŸ³â€ï¼‰
  if (Math.random() < 0.1) return;

  const freq = 700 + Math.random() * 200; // 700~900Hz
  playTone(freq, 0.02, 'square', 0.025);
}


    // ã€ä¿®æ”¹åã€‘éŸ³ä¹å¾ªç¯ï¼Œå¢åŠ äº†çº¸ç‰‡å–·å°„é€»è¾‘
function startBirthdayLoop() {
    if (musicInterval) return;
    
    // å®šä¹‰éŸ³ç¬¦ï¼šf=é¢‘ç‡, d=æ—¶é•¿(ä¹Ÿæ˜¯èŠ‚å¥å¼ºå¼±çš„ä¾æ®)
    const notes = [
        {f:261, d:0.2}, {f:261, d:0.2}, {f:293, d:0.4}, {f:261, d:0.4}, {f:349, d:0.4}, {f:329, d:0.8},
        {f:261, d:0.2}, {f:261, d:0.2}, {f:293, d:0.4}, {f:261, d:0.4}, {f:392, d:0.4}, {f:349, d:0.8},
        {f:261, d:0.2}, {f:261, d:0.2}, {f:523, d:0.4}, {f:440, d:0.4}, {f:349, d:0.4}, {f:329, d:0.4}, {f:293, d:0.4},
        {f:466, d:0.2}, {f:466, d:0.2}, {f:440, d:0.4}, {f:349, d:0.4}, {f:392, d:0.4}, {f:349, d:0.8} 
    ];
    
    let totalDuration = 0;
    notes.forEach(n => totalDuration += n.d + 0.05);
    
    const playMelody = () => {
        let time = 0;
        notes.forEach(n => {
            setTimeout(() => {
                // åªæœ‰åœ¨ç»“å±€æˆ–åˆå½±æ¨¡å¼ä¸‹æ‰æ’­æ”¾
                if(GAME.mode === 'ENDING' || GAME.mode === 'PHOTO_OP' || GAME.mode === 'FINAL_SHOWCASE') {
                    playTone(n.f, n.d, 'triangle', 0.1);
                    
                    // ã€æ–°å¢ã€‘æ ¹æ®éŸ³ç¬¦æ—¶é•¿åˆ¤æ–­èŠ‚å¥å¼ºåº¦ï¼Œç”Ÿæˆçº¸ç‰‡
                    // é•¿éŸ³ç¬¦(d>=0.4)è§†ä¸ºé‡æ‹ï¼Œçº¸ç‰‡æ›´å¤š
                    const intensity = n.d >= 0.4 ? 10 : 3; 
                    spawnConfetti(intensity); 
                }
            }, time * 1000);
            time += n.d + 0.05;
        });
    };
    playMelody();
    musicInterval = setInterval(playMelody, totalDuration * 1000);
}

// ã€æ–°å¢ã€‘ç”Ÿæˆçº¸ç‰‡çš„è¾…åŠ©å‡½æ•°
function spawnConfetti(count) {
    const colors = ['#FFC0CB', '#FFD700', '#ADFF2F', '#00BFFF', '#FF4500'];
    for (let i = 0; i < count; i++) {
        GAME.confetti.push({
            x: Math.random() * 200,      // å…¨å±éšæœºX
            y: -5,                       // ä»å±å¹•ä¸Šæ–¹è½ä¸‹
            vx: (Math.random() - 0.5) * 2, // å·¦å³éšæœºé£˜è¡
            vy: Math.random() * 1.5 + 1,   // ä¸‹è½é€Ÿåº¦
            color: colors[Math.floor(Math.random() * colors.length)],
            life: 150                    // å­˜æ´»æ—¶é—´
        });
    }
}


      // --- 1. èµ„æºä¸é…ç½® ---
    const P = {
        wall:'#F5E6CA', floor:'#E1C7A8', skirt:'#8D6E63', wood:'#8E4B26',
        glass:'rgba(225, 245, 254, 0.5)', snow:'#FFFFFF', outside:'#03162B',
        steel:'#78909C', steelHi:'#CFD8DC',
        black:'#44413B', gray:'#A7A5A3', white:'#EDE0CA', pink:'#EDCAD1', brown:'#795548',
        skin:'#FFCCBC', hairDk:'#3E2723', hairLt:'#FFAB91',
        uiBg: '#3E2723', uiBorder: '#D7BFA6', uiText: '#FFFFFF',
        card: '#FFCDD2', cakeBase: '#FFECB3', cakeIce: '#F8BBD0', flame: '#FF9800',
        ltBlue: '#81D4FA'
    };

    // Sprites (ä¿ç•™åŸä»£ç )
    const SPRITE_PLAYER_STAND = [[0,0,0,0,0,4,4,4,4,4,4,0,0,0,0,0],[0,0,0,0,4,4,4,4,4,4,4,4,0,0,0,0],[0,0,0,0,4,4,4,4,4,4,4,4,0,0,0,0],[0,0,0,0,1,1,2,2,2,2,1,1,0,0,0,0],[0,0,0,0,1,2,2,2,2,2,2,1,0,0,0,0],[0,0,0,0,0,2,2,2,2,2,2,0,0,0,0,0],[0,0,0,0,0,3,3,3,3,3,3,0,0,0,0,0],[0,0,0,0,1,3,3,3,3,3,3,1,0,0,0,0],[0,0,0,1,3,3,3,3,3,3,3,3,1,0,0,0],[0,0,0,1,3,3,3,3,3,3,3,3,1,0,0,0],[0,0,0,1,3,3,3,3,3,3,3,3,1,0,0,0],[0,0,0,0,1,3,3,3,3,3,3,1,0,0,0,0],[0,0,0,0,1,5,5,1,1,5,5,1,0,0,0,0],[0,0,0,0,1,5,5,1,1,5,5,1,0,0,0,0],[0,0,0,0,1,1,1,1,1,1,1,1,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]];
    const SPRITE_PLAYER_WALK1 = [[0,0,0,0,0,4,4,4,4,4,4,0,0,0,0,0],[0,0,0,0,4,4,4,4,4,4,4,4,0,0,0,0],[0,0,0,0,4,4,4,4,4,4,4,4,0,0,0,0],[0,0,0,0,1,1,2,2,2,2,1,1,0,0,0,0],[0,0,0,0,1,2,2,2,2,2,2,1,0,0,0,0],[0,0,0,0,0,2,2,2,2,2,2,0,0,0,0,0],[0,0,0,0,0,3,3,3,3,3,3,0,0,0,0,0],[0,0,0,0,1,3,3,3,3,3,3,1,0,0,0,0],[0,0,0,1,3,3,3,3,3,3,3,3,1,0,0,0],[0,0,0,1,3,3,3,3,3,3,3,3,1,0,0,0],[0,0,0,1,3,3,3,3,3,3,3,3,1,0,0,0],[0,0,0,0,1,3,3,3,3,3,3,1,0,0,0,0],[0,0,0,0,1,5,5,1,1,5,5,1,0,0,0,0],[0,0,0,0,0,5,5,1,1,5,5,0,0,0,0,0],[0,0,0,0,1,1,1,0,0,1,1,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]];
    const SPRITE_PLAYER_WALK2 = [[0,0,0,0,0,4,4,4,4,4,4,0,0,0,0,0],[0,0,0,0,4,4,4,4,4,4,4,4,0,0,0,0],[0,0,0,0,4,4,4,4,4,4,4,4,0,0,0,0],[0,0,0,0,1,1,2,2,2,2,1,1,0,0,0,0],[0,0,0,0,1,2,2,2,2,2,2,1,0,0,0,0],[0,0,0,0,0,2,2,2,2,2,2,0,0,0,0,0],[0,0,0,0,0,3,3,3,3,3,3,0,0,0,0,0],[0,0,0,0,1,3,3,3,3,3,3,1,0,0,0,0],[0,0,0,1,3,3,3,3,3,3,3,3,1,0,0,0],[0,0,0,1,3,3,3,3,3,3,3,3,1,0,0,0],[0,0,0,1,3,3,3,3,3,3,3,3,1,0,0,0],[0,0,0,0,1,3,3,3,3,3,3,1,0,0,0,0],[0,0,0,0,1,5,5,1,1,5,5,1,0,0,0,0],[0,0,0,0,1,5,5,1,1,5,5,1,0,0,0,0],[0,0,0,0,0,1,1,0,0,1,1,1,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]];

    const SPRITE_FEMALE_STAND = [[0,0,0,0,1,1,1,1,1,1,0,0,0,0,0,0],[0,0,0,1,1,1,1,1,1,1,1,0,0,0,0,0],[0,0,0,1,1,1,1,1,1,1,1,1,0,0,0,0],[0,0,0,1,2,2,2,2,2,2,1,0,0,0,0,0],[0,0,0,1,2,2,2,2,2,2,1,0,0,0,0,0],[0,0,0,0,2,2,2,2,2,2,0,0,0,0,0,0],[0,0,0,0,1,3,3,3,3,1,0,0,0,0,0,0],[0,0,0,0,3,3,3,3,3,3,0,0,0,0,0,0],[0,0,0,1,3,3,3,3,3,3,1,0,0,0,0,0],[0,0,0,1,3,3,3,3,3,3,1,0,0,0,0,0],[0,0,0,1,3,3,3,3,3,3,1,0,0,0,0,0],[0,0,0,0,4,4,4,4,4,4,0,0,0,0,0,0],[0,0,0,0,4,4,1,1,4,4,0,0,0,0,0,0],[0,0,0,0,4,4,1,1,4,4,0,0,0,0,0,0],[0,0,0,0,1,1,1,1,1,1,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]];
    const SPRITE_FEMALE_WALK1 = [[0,0,0,0,1,1,1,1,1,1,0,0,0,0,0,0],[0,0,0,1,1,1,1,1,1,1,1,0,0,0,0,0],[0,0,0,1,1,1,1,1,1,1,1,1,0,0,0,0],[0,0,0,1,2,2,2,2,2,2,1,0,0,0,0,0],[0,0,0,1,2,2,2,2,2,2,1,0,0,0,0,0],[0,0,0,0,2,2,2,2,2,2,0,0,0,0,0,0],[0,0,0,0,1,3,3,3,3,1,0,0,0,0,0,0],[0,0,0,0,3,3,3,3,3,3,0,0,0,0,0,0],[0,0,0,1,3,3,3,3,3,3,1,0,0,0,0,0],[0,0,0,1,3,3,3,3,3,3,1,0,0,0,0,0],[0,0,0,1,3,3,3,3,3,3,1,0,0,0,0,0],[0,0,0,0,4,4,4,4,4,4,0,0,0,0,0,0],[0,0,0,0,4,4,1,1,4,4,0,0,0,0,0,0],[0,0,0,0,0,4,4,1,1,4,4,0,0,0,0,0],[0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]];
    const SPRITE_FEMALE_WALK2 = [[0,0,0,0,1,1,1,1,1,1,0,0,0,0,0,0],[0,0,0,1,1,1,1,1,1,1,1,0,0,0,0,0],[0,0,0,1,1,1,1,1,1,1,1,1,0,0,0,0],[0,0,0,1,2,2,2,2,2,2,1,0,0,0,0,0],[0,0,0,1,2,2,2,2,2,2,1,0,0,0,0,0],[0,0,0,0,2,2,2,2,2,2,0,0,0,0,0,0],[0,0,0,0,1,3,3,3,3,1,0,0,0,0,0,0],[0,0,0,0,3,3,3,3,3,3,0,0,0,0,0,0],[0,0,0,1,3,3,3,3,3,3,1,0,0,0,0,0],[0,0,0,1,3,3,3,3,3,3,1,0,0,0,0,0],[0,0,0,1,3,3,3,3,3,3,1,0,0,0,0,0],[0,0,0,0,4,4,4,4,4,4,0,0,0,0,0,0],[0,0,0,0,4,4,1,1,4,4,0,0,0,0,0,0],[0,0,0,0,4,4,1,1,4,4,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]];

    const SPRITE_FEMALE_SIT = [[0,0,0,0,1,1,1,1,1,1,0,0,0,0,0,0],[0,0,0,1,1,1,1,1,1,1,1,0,0,0,0,0],[0,0,0,1,2,2,2,2,2,2,1,0,0,0,0,0],[0,0,0,1,2,2,2,2,2,2,1,0,0,0,0,0],[0,0,0,0,1,3,3,3,3,1,0,0,0,0,0,0],[0,0,0,0,3,3,3,3,3,3,0,0,0,0,0,0],[0,0,0,0,3,3,3,3,3,3,0,0,0,0,0,0],[0,0,0,1,3,3,3,3,3,3,1,0,0,0,0,0],[0,0,0,1,4,4,4,4,4,4,1,0,0,0,0,0],[0,0,0,0,4,4,4,4,4,4,0,0,0,0,0,0],[0,0,0,0,4,4,0,0,4,4,0,0,0,0,0,0],[0,0,0,0,1,1,0,0,1,1,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]];
    const SPRITE_CAKE = [[0,0,0,0,0,0,0,0], [0,0,0,0,0,0,0,0], [0,0,2,2,2,2,0,0], [0,1,1,1,1,1,1,0], [0,1,1,1,1,1,1,0], [1,1,1,1,1,1,1,1], [1,1,1,1,1,1,1,1], [0,0,0,0,0,0,0,0]];

    // --- 2. æ¸¸æˆæ ¸å¿ƒçŠ¶æ€ ---
    let GAME = {};
    let SCENE = {};
    let player = {};
    let snowflakes = [];

function initGame() {
    GAME = {
 // ã€æ–°å¢ã€‘æ§åˆ¶é›ªèŠ±å¯†åº¦çš„å˜é‡
        snowTarget: 10, // åˆå§‹å¯†åº¦ï¼šå¾ˆä½ (æ¯”å¦‚ 10)
        iceCream: {
            active: false,
            order: null,
            input: [],
            success: false
        },

         // ã€ä¿®æ”¹ 1ã€‘å°†æ¨¡å¼æ”¹ä¸º HAT_SELECTï¼Œå¹¶å®šä¹‰é¢œè‰²
        // ==========================================
        mode: 'HAT_SELECT', // åŸæœ¬æ˜¯ 'PLAYING'
        
        hatIndex: 0,
        hatColor: '#D84315', // é»˜è®¤æ·±çº¢
        hatOptions: [
            { name: 'RED',    hex: '#D84315' }, // ç»å…¸çº¢
            { name: 'YELLOW', hex: '#FFC107' }, // æ´»åŠ›é»„
            { name: 'BLUE',   hex: '#0C4F8A' }  // æ²‰ç¨³è“
        ],
        // ==========================================

        screenShake: 0,
confetti: [], 

        stats: {
            cards: 0, // è¿™ä¸ªå˜é‡å†³å®šæš–å…‰ç¨‹åº¦
            talkedNpcs: new Set(),
            miniGameWon: false,
            hiddenSecretRead: false,
            allTasksDone: false 
        },
        stats: {
            cards: 0,
            talkedNpcs: new Set(),
            miniGameWon: false,
            hiddenSecretRead: false,
            allTasksDone: false 
        },
        chase: { active: false, timer: 0 }, 
        dialog: { text: "", displayBuffer: "", charIndex: 0, timer: 0, targetName: "" },
         miniGame: { 
            pos: 0, 
            dir: 1, 
            
            // ã€æ–°å¢ã€‘éš¾åº¦æ ‡è®°ï¼Œé»˜è®¤æ­£å¸¸
            difficulty: 'NORMAL', 
            
            // åˆå§‹é€Ÿåº¦ (æ­£å¸¸: 2.5)
            speed: 2.5, 
            
            // åˆå§‹åˆ¤å®šåŒº (æ­£å¸¸: 42-58ï¼Œå®½åº¦16)
            targetZone: { start: 42, end: 58 }, 
            
            result: null, 
            cooldown: 0 
        },
        vfx: [],
        partyState: { gfStage: 0, melodyPlayed: false },
        photoOp: { timer: 0, phase: 'idle' },
        toast: { text: "", timer: 0 }
    };

    SCENE = {
        window: { x: 50, y: 5, w: 100, h: 20 },
        furniture: [
            { type: 'wall', x: 0, y: 0, w: 200, h: 30 },
            { type: 'wall', x: 0, y: 100, w: 10, h: 50 },
            { type: 'wall', x: 0, y: 30, w: 10, h: 30 },
            { type: 'bench_v', x: 180, y: 60, w: 12, h: 45 },
            { type: 'stool', x: 60, y: 35, w: 10, h: 10 },
            { type: 'stool', x: 100, y: 35, w: 10, h: 10 },
            { type: 'stool', x: 140, y: 35, w: 10, h: 10 },
            { type: 'counter', x: 50, y: 110, w: 100, h: 20 }
        ], 
        cards: [
            { x: 165, y: 70, collected: false }, 
            { x: 45, y: 125, collected: false }, 
            { x: 5, y: 65, collected: false }    
        ],
        npcs: [
            { id: 'staff1', name: 'KDAE', x: 60, y: 130, sprite: SPRITE_FEMALE_STAND, colors: {1:P.hairDk, 2:P.skin, 3:P.ltBlue, 4:P.black}, dialogList: [
    "ç”Ÿæ—¥å¿«ä¹ï¼Œå¸…æ˜¯ä¸€ç§æ„Ÿè§‰ï¼",
    "åº—çš„è§’è½é‡Œå¥½åƒè—ç€å‡ å¼ è´ºå¡å“¦ã€‚"
  ],
  dialogIdx: 0, targetPos: {x:70, y:80} },
            { id: 'staff2', name: 'å¸ƒæ²³', x: 120, y: 130, sprite: SPRITE_FEMALE_STAND, colors: {1:P.hairDk, 2:P.skin, 3:P.gray, 4:P.black}, msg: "ç”Ÿæ—¥å¿«ä¹ï¼Œé€ä½ ä¸€å¨ç²‘ç²‘å†°æ·‡æ·‹ã€‚", targetPos: {x:130, y:80} },
            { id: 'staff3', name: 'SHERBET LEMON', x: 99, y: 27, sprite: SPRITE_FEMALE_SIT, colors: {1:P.black, 2:P.skin, 3:P.pink, 4:P.white}, msg: "ç”Ÿæ—¥å¿«ä¹!æˆä¸ºå¥åº·çš„å†°æ·‡æ·‹å¤§å¸ˆå§ï¼", targetPos: {x:90, y:73} },
            
            // === æ±¤æ±¤ï¼šåæ ‡ x:160, y:75 (é¿å¼€éšœç¢ç‰©) ===
            { 
                id: 'gf', name: 'æ±¤æ±¤', x: 160, y: 75, sprite: SPRITE_FEMALE_SIT, colors: {1:P.hairDk, 2:P.skin, 3:'#3D3C37', 4:'#232220'}, 
                msg: "", targetPos: {x:100, y:85}, hasCake: false, animTimer: 0,
                dialogList: ["ï¼ˆæˆ³ï¼‰", "ç¥ä½ â€”ç”Ÿæ—¥â€”â€”å¿«ä¹â€”", "ï¼ˆä¸è´´ï¼‰ï¼ˆæˆ³ï¼‰", "å®‡å®™æµæ˜Ÿå¼ºåŠ›æˆ³æˆ³æ‹³ï¼ˆè¯·ç»•åœºä¸€å‘¨ï¼‰"],
                dialogIdx: 0,
                wander: { timer: 0, dx: 0, dy: 0 } // å¿…é¡»è¦æœ‰è¿™ä¸ªå±æ€§
            },
            // === BOOï¼šåæ ‡ x:137, y:50 (é¿å¼€å¢™å£) ===
            { 
                id: 'cust', name: 'BOO', x: 137, y: 50, sprite: SPRITE_FEMALE_SIT, colors: {1:P.black, 2:P.skin, 3:'#552961', 4:'#333'}, 
                msg: "å‰‘ç‰å¤§å¸ˆç”Ÿæ—¥å¿«ä¹ã€‚", msgWin: "å°‘ç»ƒç‚¹å‰‘å§ï¼", targetPos: {x:115, y:65},
                wander: { timer: 0, dx: 0, dy: 0 } // å¿…é¡»è¦æœ‰è¿™ä¸ªå±æ€§
            },
            // === æ–°NPCï¼šCherish ===
            { 
                id: 'cherish', name: 'Cherish', x: 35, y: 90, 
                sprite: SPRITE_FEMALE_SIT, 
                colors: {1:P.hairDk, 2:P.skin, 3:'#FFDE59', 4:'#BA3232'}, // å¤åˆ¶æ±¤æ±¤çš„é…è‰²
                msg: "ç”Ÿæ—¥å¿«ä¹ï¼Œä»€ä¹ˆæ—¶å€™åŠæ´»åŠ¨ï¼Ÿ", 
                targetPos: {x:50, y:85}, // ç»“å±€æ—¶çš„ç«™ä½
                wander: { timer: 0, dx: 0, dy: 0 } 
            }

        ],
        cakeObj: null 
    };

    player = { 
        x: 10, y: 80, w: 14, h: 14, speed: 1.2, 
        colors: {1:'#3E2723', 2:P.skin, 3:'#FFF3E0', 4:'#D84315', 5:'#4E342E'},
        animTimer: 0,
        jumpY: 0, vy: 0 
    };
    
     snowflakes = Array.from({length: GAME.snowTarget}, () => ({ 
        x: Math.random()*SCENE.window.w + SCENE.window.x, 
        y: Math.random()*SCENE.window.h + SCENE.window.y, 
        speed: Math.random()*0.5+0.1 
    }));
}
    const keys = { w:false, a:false, s:false, d:false };

    // --- 4. é€»è¾‘æ§åˆ¶ ---
    function spawnVFX(type, x, y) {
        GAME.vfx.push({ type, x, y, life: 60, offset: 0 });
    }

    function checkEndgameCondition() {
    // å®Œæˆæ¡ä»¶ï¼šæ”¶é›†3å¼ å¡ + 6ä¸ªNPCå®Œæ•´å¯¹è¯
    if (GAME.stats.cards === 3 && GAME.stats.talkedNpcs.size === 6) {
        GAME.stats.allTasksDone = true;
    } else {
        GAME.stats.allTasksDone = false;
    }
}


     function startDialog(npc) {
// === å¸ƒæ²³ï¼šå†°æ·‡æ·‹åˆ¶ä½œæ”¯çº¿ ===
if (npc.id === 'staff2' && !GAME.iceCream.success) {
  GAME.mode = 'ICE_CREAM';
  GAME.iceCream.active = true;
  GAME.iceCream.order = ICE_CREAM_RECIPE;
  GAME.iceCream.input = [];
  return;
}

    if (npc.id === 'gf' && GAME.stats.allTasksDone) {
        GAME.mode = 'PARTY_SEQUENCE';
        SCENE.npcs.forEach(n => { if(n.sprite === SPRITE_FEMALE_SIT) n.sprite = SPRITE_FEMALE_STAND; });
        return;
    }

    GAME.mode = 'DIALOG';
    GAME.dialog.targetName = npc.name;
    GAME.dialog.charIndex = 0; GAME.dialog.displayBuffer = ""; GAME.dialog.timer = 0;
    
    // === é€»è¾‘ï¼šæ±¤æ±¤å¤šæ®µå¯¹è¯ ===
    if (npc.dialogList) {
    if (npc.dialogIdx >= npc.dialogList.length) npc.dialogIdx = 0;
    GAME.dialog.text = npc.dialogList[npc.dialogIdx];
}
 
    else if(npc.id === 'cust' && GAME.stats.miniGameWon) {
        GAME.dialog.text = npc.msgWin;
        GAME.stats.hiddenSecretRead = true;
        GAME.stats.talkedNpcs.add(npc.id); // å…¶ä»–äººæ­£å¸¸æ¶ˆé™¤æ„Ÿå¹å·
        checkEndgameCondition();
    } else {
        GAME.dialog.text = npc.msg;
        GAME.stats.talkedNpcs.add(npc.id); // å…¶ä»–äººæ­£å¸¸æ¶ˆé™¤æ„Ÿå¹å·
        checkEndgameCondition();
    }
}
    function startMiniGame() {
        GAME.mode = 'MINIGAME';
        GAME.miniGame.pos = 0; 
        GAME.miniGame.dir = 1; 
        GAME.miniGame.result = null;
        GAME.miniGame.cooldown = 30; 
    }

const ICE_CREAM_RECIPE = {
  name: "ç‰¹æ®Šå£å‘³å†°æ·‡æ·‹",
  seq: ['ArrowLeft', 'ArrowRight', 'A']
};

        function checkCollision(x, y) {
        const pRect = { x: x+2, y: y+8, w: 10, h: 8 };
        for(let obj of SCENE.furniture) if(pRect.x < obj.x + obj.w && pRect.x + pRect.w > obj.x && pRect.y < obj.y + obj.h && pRect.y + pRect.h > obj.y) return true;
        if(GAME.mode !== 'PARTY_SEQUENCE' && GAME.mode !== 'ENDING' && GAME.mode !== 'FINAL_SHOWCASE') {
            for (let npc of SCENE.npcs) {
  // è¿½é€ä¸­ï¼šå¿½ç•¥æ±¤æ±¤çš„å®ä½“ç¢°æ’
  if (npc.id === 'gf' && GAME.chase.active) continue;

  if (
    pRect.x < npc.x + 12 &&
    pRect.x + pRect.w > npc.x + 4 &&
    pRect.y < npc.y + 16 &&
    pRect.y + pRect.h > npc.y + 8
  ) {
    return true;
  }
}

        }
        if (x < 0) return true;
        if (x > 200-14 || y < 30 || y > 150-14) return true;
        return false;
    }

    function checkCollection() {
        const pCenter = { x: player.x + 7, y: player.y + 7 };
        SCENE.cards.forEach(card => {
            if(!card.collected) {
                const dx = pCenter.x - (card.x + 2); const dy = pCenter.y - (card.y + 2);
                if(Math.sqrt(dx*dx + dy*dy) < 10) {
                    card.collected = true;
                    GAME.stats.cards++;
                    spawnVFX('envelope', player.x+4, player.y-10);
                    playJingle();
                    checkEndgameCondition();
                }
            }
        });
    }

       function handleInteraction() {

  
// === GameBoy å¯åŠ¨ç”»é¢ â†’ æ­£å¼æ¸¸æˆ ===
if (SYSTEM && SYSTEM.state === 'TITLE') {
  initAudio();          // â† å…³é”®ï¼šç¬¬ä¸€æ¬¡ç”¨æˆ·äº¤äº’è§£é”éŸ³é¢‘
  playTone(880, 0.1);   // â† å¯é€‰ï¼šç¡®è®¤éŸ³
  SYSTEM.state = 'GAME';
  initGame();
start8BitBGM();
  return;
}


    // 1. ç»“å±€ç›¸å†Œé€»è¾‘
    if (GAME.mode === 'FINAL_SHOWCASE') { initGame(); return; }

    // 2. æ‹ç…§é€»è¾‘
    if (GAME.mode === 'ENDING') {
        playShutterSound();
        GAME.mode = 'PHOTO_OP';
        GAME.photoOp.timer = 0;
        GAME.photoOp.phase = 'flash';
        return;
    }

    // 3. å¯¹è¯è¿›è¡Œä¸­é€»è¾‘
    if(GAME.mode === 'DIALOG') {
        // å¦‚æœå­—æ²¡æ‰“å®Œï¼Œç‚¹å‡»åˆ™ç¬é—´æ˜¾ç¤ºå…¨
        if(GAME.dialog.displayBuffer.length < GAME.dialog.text.length) {
            GAME.dialog.displayBuffer = GAME.dialog.text;
            GAME.dialog.charIndex = GAME.dialog.text.length;
        } else {
            // === å¯¹è¯æ¡†å…³é—­ï¼ˆå¯¹è¯ç»“æŸï¼‰æ—¶çš„é€»è¾‘ ===
            const npc = SCENE.npcs.find(n => n.name === GAME.dialog.targetName);
            
            if (npc && npc.id === 'gf') {
                // --- æ±¤æ±¤çš„ç‰¹æ®Šé€»è¾‘ ---
                
                // ç¬¬1å¥ç»“æŸåï¼šä¸»è§’è·³è·ƒ
                if (npc.dialogIdx === 0) {
                    player.vy = -3.0; // å‘ä¸Šè·³è·ƒåŠ›åº¦
                }
                if (npc.dialogIdx === 2) {
                    player.vy = -3.0; // å‘ä¸Šè·³è·ƒåŠ›åº¦
                }

                
                // ç¬¬4å¥ç»“æŸåï¼šå®Œæˆå¯¹è¯ï¼Œæ¶ˆé™¤æ„Ÿå¹å·ï¼Œå¼€å§‹è¿½é€
                if (npc.dialogIdx === 3) {
                    // å¼€å¯è¿½é€
                    GAME.chase.active = true;
                    GAME.chase.timer = 400; // è¿½é€æŒç»­çº¦ 6ç§’
                    npc.sprite = SPRITE_FEMALE_STAND; // ç¡®ä¿å¥¹æ˜¯ç«™ç«‹è´´å›¾
                    
                    // ã€å…³é”®ç‚¹ã€‘åœ¨è¿™é‡Œæ‰æ ‡è®°ä¸ºâ€œå·²å¯¹è¯â€ï¼Œæ¶ˆé™¤æ„Ÿå¹å·
                    GAME.stats.talkedNpcs.add('gf'); 
                    checkEndgameCondition();
                }

                // å‡†å¤‡ä¸‹ä¸€å¥ï¼ˆä¸ºäº†é˜²æ­¢æ•°ç»„è¶Šç•Œï¼Œè¿™é‡Œåšä¸€ä¸ªå°é™åˆ¶ï¼‰
                npc.dialogIdx++;
                // å¦‚æœèŠå®Œäº†4å¥ï¼Œä¸‹æ¬¡å¯¹è¯é‡ç½®å›ç¬¬1å¥ï¼ˆå¯é€‰ï¼Œè§†æ‚¨éœ€æ±‚è€Œå®šï¼‰
                if (npc.dialogIdx >= npc.dialogList.length) {
                   // npc.dialogIdx = 0; // å¦‚æœæ‚¨å¸Œæœ›å¥¹æ°¸è¿œå¾ªç¯è¯´è¿™4å¥ï¼Œå–æ¶ˆæ­¤è¡Œæ³¨é‡Š
                }
            }

            // æ¢å¤æ¸¸æˆæ§åˆ¶æƒ
if (npc && npc.dialogList && npc.id !== 'gf') {
    npc.dialogIdx++;

    if (npc.dialogIdx >= npc.dialogList.length) {
        GAME.stats.talkedNpcs.add(npc.id);
        checkEndgameCondition();
    }
}


            GAME.mode = 'PLAYING';
            
            // å¦‚æœæ˜¯å‰‘ç‰å¤§å¸ˆ BOO ä¸”æ²¡èµ¢è¿‡å°æ¸¸æˆï¼Œè§¦å‘å°æ¸¸æˆ
            if(npc && npc.id === 'cust' && !GAME.stats.miniGameWon) startMiniGame();
        }
        return;
    }

        // 4. å°æ¸¸æˆé€»è¾‘
    if(GAME.mode === 'MINIGAME') {
        if(GAME.miniGame.result) { GAME.mode = 'PLAYING'; return; }
        if(GAME.miniGame.cooldown > 0) return;
        const p = GAME.miniGame.pos; const z = GAME.miniGame.targetZone;
        
        // --- ä¿®æ”¹å¼€å§‹ ---
        if(p >= z.start && p <= z.end) {
            GAME.miniGame.result = 'SUCCESS'; 
            GAME.stats.miniGameWon = true;
            
            // [ä¿®æ”¹] 1. è§¦å‘å±å¹•éœ‡åŠ¨ (å¼ºåº¦è®¾ä¸º 10)
            GAME.screenShake = 10; 
            
            // [ä¿®æ”¹] 2. æ’­æ”¾æ–°çš„éŸ³æ•ˆ
            spawnVFX('note', player.x+4, player.y-10); 
            playWinArpeggio(); 
            
        } else { 
            GAME.miniGame.result = 'FAIL'; 
            // å¤±è´¥æ—¶å¯ä»¥åŠ ä¸€ä¸ªå°å°çš„éœ‡åŠ¨ï¼ˆå¯é€‰ï¼‰
            GAME.screenShake = 3; 
        }
        // --- ä¿®æ”¹ç»“æŸ ---
        
        return;
    }


    // 5. å¯»æ‰¾æœ€è¿‘çš„NPCè§¦å‘å¯¹è¯
    const pCenter = { x: player.x + 7, y: player.y + 7 };
    let nearestDist = 20; let targetNPC = null;
    SCENE.npcs.forEach(npc => {
        const nCenter = { x: npc.x + 8, y: npc.y + 8 };
        const d = Math.sqrt((pCenter.x-nCenter.x)**2 + (pCenter.y-nCenter.y)**2);
        if(d < nearestDist) { nearestDist = d; targetNPC = npc; }
    });
    if(targetNPC) startDialog(targetNPC);
}

      function update() {
    // 1. ç¯å¢ƒæ›´æ–°

// ã€æ–°å¢ã€‘æ›´æ–°çº¸ç‰‡ä½ç½®
    if (GAME.confetti) {
        GAME.confetti.forEach(p => {
            p.x += p.vx;
            p.y += p.vy;
            p.life--;
        });
        // ç§»é™¤è¶…å‡ºå±å¹•æˆ–å¯¿å‘½ç»“æŸçš„çº¸ç‰‡
        GAME.confetti = GAME.confetti.filter(p => p.y < 160 && p.life > 0);
    }
    if (GAME.screenShake > 0) {
        GAME.screenShake *= 0.9; // æ¯æ¬¡å‡å¼± 10%
        if (GAME.screenShake < 0.5) GAME.screenShake = 0;
    }
    for (let i = snowflakes.length - 1; i >= 0; i--) {
        let p = snowflakes[i];
        p.y += p.speed;
        
        // å¦‚æœé›ªèŠ±è½å‡ºäº†çª—æˆ·åº•éƒ¨
        if (p.y > SCENE.window.y + SCENE.window.h) {
            // å¦‚æœå½“å‰é›ªèŠ±æ•°é‡ è¶…è¿‡äº† ç›®æ ‡æ•°é‡ï¼Œè¿™ä¸ªé›ªèŠ±å°±æ¶ˆå¤±ï¼ˆä¸é‡ç½®ï¼‰
            if (snowflakes.length > GAME.snowTarget) {
                snowflakes.splice(i, 1);
            } else {
                // å¦åˆ™ï¼Œå¾ªç¯åˆ©ç”¨ï¼Œå›åˆ°é¡¶éƒ¨
                p.y = SCENE.window.y;
                p.x = Math.random() * SCENE.window.w + SCENE.window.x;
            }
        }
    }

    // 2. å¦‚æœé›ªèŠ±ä¸å¤Ÿï¼Œè¡¥å……æ–°çš„
    if (snowflakes.length < GAME.snowTarget) {
        // æ¯æ¬¡è¡¥å……ä¸€ç‚¹ç‚¹ï¼Œåˆ¶é€ æ¸å˜æ•ˆæœ
        snowflakes.push({
            x: Math.random() * SCENE.window.w + SCENE.window.x,
            y: SCENE.window.y, // ä»çª—æˆ·é¡¶éƒ¨ç”Ÿæˆ
            speed: Math.random() * 0.5 + 0.1
        });
    }
    GAME.vfx.forEach(v => { v.life--; v.offset -= 0.2; });
    GAME.vfx = GAME.vfx.filter(v => v.life > 0);
    if (GAME.toast.timer > 0) GAME.toast.timer--;

    // ================== PLAYING æ¨¡å¼ ==================
    if (GAME.mode === 'PLAYING') {
        let dx = 0, dy = 0;
        if(keys.w) dy -= player.speed; if(keys.s) dy += player.speed; if(keys.a) dx -= player.speed; if(keys.d) dx += player.speed;
        
        if (keys.a && player.x < 5 && player.y > 60 && player.y < 100) {
            GAME.toast.text = "å¤–é¢æ­£åœ¨ä¸‹é›ªå‘¢..."; GAME.toast.timer = 60; 
        }

        // --- ä¸»è§’ç‰©ç† (è·³è·ƒ) ---
        if (player.vy !== 0 || player.jumpY !== 0) {
            player.jumpY += player.vy; 
            player.vy += 0.3; 
            if (player.jumpY >= 0) { player.jumpY = 0; player.vy = 0; }
        }

        // --- ä¸»è§’ç§»åŠ¨ (ä¸»è§’ä¾ç„¶éœ€è¦ä¸¥è°¨çš„ç¢°æ’æ£€æµ‹) ---
        if(dx !== 0 || dy !== 0) {
            player.animTimer++;
            if(!checkCollision(player.x+dx, player.y)) player.x += dx;
            if(!checkCollision(player.x, player.y+dy)) player.y += dy;
            checkCollection();
        } else {
            player.animTimer = 0;
        }

        // ================== NPC AI é€»è¾‘ (ä¿®å¤ç‰ˆ) ==================
        SCENE.npcs.forEach(npc => {
            let moved = false;
            let moveX = 0, moveY = 0;
            let isChasing = false;

            // 1. è®¡ç®—ç§»åŠ¨æ„å›¾
            if (npc.id === 'gf' && GAME.chase.active && GAME.chase.timer > 0) {
                // --- è¿½é€æ¨¡å¼ ---
                isChasing = true;
                GAME.chase.timer--;
                const speed = 1.1; 
                const distX = player.x - npc.x;
                const distY = player.y - npc.y;
                const dist = Math.sqrt(distX*distX + distY*distY);
                
                if (dist > 18) { 
                    moveX = (distX / dist) * speed;
                    moveY = (distY / dist) * speed;
                }
                
                if (GAME.chase.timer <= 0) {
                    GAME.chase.active = false;
                    npc.sprite = SPRITE_FEMALE_SIT;
                } else {
                    npc.sprite = SPRITE_FEMALE_STAND;
                }
            }
            else if (npc.wander) {
                // --- éšæœºæ¸¸è¡æ¨¡å¼ ---
                npc.wander.timer--;
                if (npc.wander.timer <= 0) {
                    npc.wander.timer = Math.floor(Math.random() * 90) + 60;
                    if (Math.random() < 0.6) {
                        const angle = Math.random() * Math.PI * 2;
                        const wSpeed = 0.5;
                        npc.wander.dx = Math.cos(angle) * wSpeed;
                        npc.wander.dy = Math.sin(angle) * wSpeed;
                    } else {
                        npc.wander.dx = 0; npc.wander.dy = 0;
                    }
                }
                moveX = npc.wander.dx;
                moveY = npc.wander.dy;
            }

            // 2. æ‰§è¡Œç§»åŠ¨ (ä½¿ç”¨â€œå®‰å…¨åŒºåŸŸâ€åˆ¤æ–­ï¼Œè€Œä¸æ˜¯ç¢°æ’æ£€æµ‹)
            if (moveX !== 0 || moveY !== 0) {
                let nextX = npc.x + moveX;
                let nextY = npc.y + moveY;

                // ã€å…³é”®ä¿®å¤ã€‘åªè¦åœ¨æˆ¿é—´çš„å®‰å…¨èŒƒå›´å†…ï¼Œå°±å…è®¸ç§»åŠ¨ï¼Œæ— è§†å®¶å…·ç¢°æ’
                // æˆ¿é—´èŒƒå›´å¤§çº¦æ˜¯ï¼šX(10~190), Y(35~100)
                if (nextX > 10 && nextX < 190 && nextY > 35 && nextY < 100) {
                    npc.x = nextX;
                    npc.y = nextY;
                    moved = true;
                    // å¦‚æœåœ¨æ¸¸è¡ä¸”ç§»åŠ¨ä¸­ï¼Œç¡®ä¿æ˜¯ç«™ç«‹å§¿æ€
                    if (!isChasing && npc.sprite === SPRITE_FEMALE_SIT) {
                        npc.sprite = SPRITE_FEMALE_STAND;
                    }
                } else {
                    // æ’åˆ°æˆ¿é—´è¾¹ç•Œäº†ï¼Œå¦‚æœæ˜¯æ¸¸è¡ï¼Œå°±åå¼¹ä¸€ä¸‹
                    if (npc.wander) {
                        npc.wander.dx *= -1;
                        npc.wander.dy *= -1;
                    }
                }
            }

            // 3. åŠ¨ç”»çŠ¶æ€
            if (moved) {
                npc.animTimer++;
            } else {
                npc.animTimer = 0;
                // æ²¡åœ¨åŠ¨çš„æ—¶å€™ï¼Œå¦‚æœä¸å¤„äºè¿½é€çŠ¶æ€ï¼Œå¯ä»¥å˜å›åä¸‹ï¼ˆæ˜¾å¾—å¯çˆ±ï¼‰
                if (!isChasing && !moved && (npc.id === 'gf' || npc.id === 'cust')) {
                     npc.sprite = SPRITE_FEMALE_SIT;
                }
            }
        });
    } 
    // ================== å…¶ä»–æ¨¡å¼é€»è¾‘ ==================
    else if (GAME.mode === 'DIALOG') {
        if (GAME.dialog.charIndex < GAME.dialog.text.length) {
    GAME.dialog.timer++;

    const currentChar = GAME.dialog.text[GAME.dialog.charIndex];

    // === åŸºç¡€é€Ÿåº¦ ===
    let waitTime = 3; // é»˜è®¤æ¯ 3 å¸§ä¸€ä¸ªå­—ï¼ˆä½ åŸæ¥çš„é€Ÿåº¦ï¼‰

    // === æ ‡ç‚¹åœé¡¿ï¼ˆGameBoy çµé­‚ï¼‰===
    if ("ï¼Œã€".includes(currentChar)) waitTime = 6;
    if ("ã€‚ï¼ï¼Ÿã€".includes(currentChar)) waitTime = 10;
    if ("â€¦".includes(currentChar)) waitTime = 14;
    if ("â€”".includes(currentChar)) waitTime = 12;

    // === å¾®éšæœºå»¶è¿Ÿï¼ˆCPU çŠ¹è±«æ„Ÿï¼‰===
    if (Math.random() < 0.05) waitTime += 3;

    if (GAME.dialog.timer >= waitTime) {
    GAME.dialog.displayBuffer += currentChar;
    GAME.dialog.charIndex++;
    GAME.dialog.timer = 0;

    playTextBeep(); // â† è€ GameBoy æ‰“å­—éŸ³
}
}

    }
    else if (GAME.mode === 'MINIGAME') {
        if(GAME.miniGame.cooldown > 0) GAME.miniGame.cooldown--;
        if(!GAME.miniGame.result) {
            GAME.miniGame.pos += GAME.miniGame.speed * GAME.miniGame.dir;
            if(GAME.miniGame.pos >= 100 || GAME.miniGame.pos <= 0) GAME.miniGame.dir *= -1;
        }
    }
    else if (GAME.mode === 'PARTY_SEQUENCE') {
        const gf = SCENE.npcs.find(n=>n.id==='gf');
        if(!gf) return;
        let currentSpeed = 0.8; 
        let gfMoving = false;

        if (GAME.partyState.gfStage === 0) {
            if (gf.x > 5) { gf.x -= currentSpeed; gfMoving=true; }
            if (gf.y > 80) { gf.y -= currentSpeed; gfMoving=true; } else if (gf.y < 80) { gf.y += currentSpeed; gfMoving=true; }
            if (gf.x <= 5 && Math.abs(gf.y - 80) < 2) GAME.partyState.gfStage = 1;
        } else if (GAME.partyState.gfStage === 1) {
            gf.hasCake = true; GAME.partyState.gfStage = 2;
        } else if (GAME.partyState.gfStage === 2) {
            currentSpeed = 0.4;
            const tx = gf.targetPos.x, ty = gf.targetPos.y;
            if (Math.abs(gf.x - tx) > 1) { gf.x += (tx > gf.x ? currentSpeed : -currentSpeed); gfMoving=true; }
            if (Math.abs(gf.y - ty) > 1) { gf.y += (ty > gf.y ? currentSpeed : -currentSpeed); gfMoving=true; }
            if (Math.abs(gf.x - tx) < 2 && Math.abs(gf.y - ty) < 2) GAME.partyState.gfStage = 3;
        }
        
        if(gfMoving) gf.animTimer += (currentSpeed > 0.5 ? 1 : 0.5); else gf.animTimer = 0;

        let allArrived = true;
        SCENE.npcs.forEach(npc => {
            if (npc.id === 'gf') return;
            const tx = npc.targetPos.x, ty = npc.targetPos.y;
            const otherSpeed = 0.8;
            if (Math.abs(npc.x - tx) > 1) { npc.x += (tx > npc.x ? otherSpeed : -otherSpeed); allArrived = false; }
            if (Math.abs(npc.y - ty) > 1) { npc.y += (ty > npc.y ? otherSpeed : -otherSpeed); allArrived = false; }
        });

        if (allArrived && GAME.partyState.gfStage === 3) {
            GAME.mode = 'ENDING';
            gf.hasCake = false;
            SCENE.cakeObj = { x: gf.x+4, y: gf.y+8 };
            player.x = 90; player.y = 100; player.animTimer = 0;
        }
    }
    else if (GAME.mode === 'ENDING') {
  if (!GAME.partyState.melodyPlayed) {
    stop8BitBGM();        // â­ åœæ‰æ—¥å¸¸ BGM
    startBirthdayLoop(); // ğŸ‚ ç”Ÿæ—¥æ­Œ
    GAME.partyState.melodyPlayed = true;
  }
}

    else if (GAME.mode === 'PHOTO_OP') {
        GAME.photoOp.timer++;
        if (GAME.photoOp.phase === 'flash') {
            if (GAME.photoOp.timer > 10) { GAME.photoOp.phase = 'develop'; GAME.photoOp.timer = 0; }
        } else if (GAME.photoOp.phase === 'develop') {
            if (GAME.photoOp.timer > 150) { GAME.mode = 'FINAL_SHOWCASE'; }
        }
    }
}

    // --- 5. æ¸²æŸ“ç³»ç»Ÿ ---
    function drawText(str, x, y, color='#fff', align='left') {
        ctx.font = '10px Courier New'; 
        ctx.textAlign = align;
        ctx.textBaseline = 'top';
        ctx.fillStyle = '#000';
        ctx.fillText(str, Math.floor(x)+1, Math.floor(y)+1);
        ctx.fillStyle = color;
        ctx.fillText(str, Math.floor(x), Math.floor(y));
    }

    function drawSprite(matrix, px, py, colors, bounce=0) {
        const drawY = Math.floor(py + bounce); 
        const drawX = Math.floor(px);
        for(let y=0; y<16; y++) {
            for(let x=0; x<16; x++) {
                let c = matrix[y][x];
                if(c !== 0) { ctx.fillStyle = colors[c] || '#f0f'; ctx.fillRect(drawX+x, drawY+y, 1, 1); }
            }
        }
    }

    function drawCake(px, py) {
        for(let y=0; y<8; y++) {
            for(let x=0; x<8; x++) {
                let c = SPRITE_CAKE[y][x];
                if(c === 1) ctx.fillStyle = P.cakeBase; else if (c === 2) ctx.fillStyle = P.cakeIce; else continue;
                ctx.fillRect(Math.floor(px+x), Math.floor(py+y), 1, 1);
            }
        }
        ctx.fillStyle = '#E91E63'; ctx.fillRect(Math.floor(px)+2, Math.floor(py), 1, 2); ctx.fillRect(Math.floor(px)+5, Math.floor(py), 1, 2);
        if (Math.floor(Date.now()/100)%2 === 0) {
            ctx.fillStyle = P.flame; ctx.fillRect(Math.floor(px)+2, Math.floor(py)-1, 1, 1); ctx.fillRect(Math.floor(px)+5, Math.floor(py)-1, 1, 1);
        }
    }

function checkIceCreamResult() {
  const need = GAME.iceCream.order.seq.join(',');
  const got  = GAME.iceCream.input.join(',');

  if (need === got) {
    GAME.iceCream.success = true;
    GAME.mode = 'DIALOG';

    const npc = SCENE.npcs.find(n => n.id === 'staff2');

    GAME.dialog.text = "é€ä½ ä¸€å¨ç²‘ç²‘å†°æ·‡æ·‹ï¼";
    GAME.dialog.targetName = npc.name;
    GAME.dialog.displayBuffer = "";
    GAME.dialog.charIndex = 0;

    GAME.stats.talkedNpcs.add('staff2');
    checkEndgameCondition();

    playWinArpeggio();
  } else {
    GAME.iceCream.input = [];
    GAME.toast.text = "è¿™ä¹Ÿèƒ½é”™...";
    GAME.toast.timer = 60;
  }
}

    function drawBox(x, y, w, h, bg=P.uiBg) { 
        x=Math.floor(x); y=Math.floor(y); w=Math.floor(w); h=Math.floor(h);
        ctx.fillStyle = bg; ctx.fillRect(x, y, w, h); ctx.strokeStyle = P.uiBorder; ctx.lineWidth = 2; ctx.strokeRect(x+1, y+1, w-2, h-2); 
    }

    function drawBigText(text, x, y, color) {
        ctx.fillStyle = color;
        const scale = 2;
        const font = {
            'H':[[1,0,1],[1,0,1],[1,1,1],[1,0,1],[1,0,1]], 'A':[[0,1,0],[1,0,1],[1,1,1],[1,0,1],[1,0,1]], 'P':[[1,1,0],[1,0,1],[1,1,1],[1,0,0],[1,0,0]],
            'Y':[[1,0,1],[1,0,1],[0,1,0],[0,1,0],[0,1,0]], 'B':[[1,1,0],[1,0,1],[1,1,0],[1,0,1],[1,1,0]], 'I':[[1],[1],[1],[1],[1]],
            'R':[[1,1,0],[1,0,1],[1,1,0],[1,0,1],[1,0,1]], 'T':[[1,1,1],[0,1,0],[0,1,0],[0,1,0],[0,1,0]], 'D':[[1,1,0],[1,0,1],[1,0,1],[1,0,1],[1,1,0]],
            '!':[[1],[1],[1],[0],[1]], ' ': [[0,0],[0,0],[0,0],[0,0],[0,0]]
        };
        let curX = Math.floor(x);
        for(let i=0; i<text.length; i++) {
            let char = font[text[i]] || font[' '];
            for(let r=0; r<5; r++) { for(let c=0; c<char[r].length; c++) { if(char[r][c]) ctx.fillRect(curX + c*scale, Math.floor(y) + r*scale, scale, scale); } }
            curX += (char[0].length + 1) * scale;
        }
    }

    function drawScene() {
        ctx.fillStyle = P.wall; ctx.fillRect(0,0,200,30);
        ctx.fillStyle = P.floor; ctx.fillRect(0,30,200,120);
        ctx.fillStyle = P.skirt; ctx.fillRect(0,29,200,1);
        ctx.fillStyle = '#A1887F'; ctx.fillRect(0, 60, 10, 40);

        ctx.save(); ctx.beginPath(); ctx.rect(SCENE.window.x, SCENE.window.y, SCENE.window.w, SCENE.window.h);
        ctx.fillStyle = P.outside; ctx.fill(); ctx.strokeStyle = '#3E2723'; ctx.stroke(); ctx.clip();
        ctx.fillStyle = P.snow; snowflakes.forEach(p => ctx.fillRect(Math.floor(p.x), Math.floor(p.y), 2, 2)); ctx.restore();

        SCENE.cards.forEach(c => {
            if(!c.collected) {
                const glow = Math.sin(Date.now() / 150) * 0.3 + 0.5;
                ctx.fillStyle = `rgba(255, 215, 0, ${glow})`;
                ctx.fillRect(Math.floor(c.x)-2, Math.floor(c.y)-2, 9, 8); 
            }
        });

        const b = SCENE.furniture.find(f => f.type === 'bench_v'); ctx.fillStyle = P.wood; ctx.fillRect(b.x, b.y, b.w, b.h); ctx.fillStyle = 'rgba(0,0,0,0.1)'; ctx.fillRect(b.x, b.y, 2, b.h);
        SCENE.furniture.filter(f=>f.type==='stool').forEach(s => { ctx.fillStyle = P.steel; ctx.fillRect(s.x+4, s.y, 2, 10); ctx.fillStyle = P.steelHi; ctx.beginPath(); ctx.arc(s.x+5, s.y, 5, 0, Math.PI*2); ctx.fill(); });

        const renderList = SCENE.npcs.map(n => {
            let currentSprite = n.sprite;
            let bounce = 0;
            if((n.id === 'gf' || n.id === 'cherish' || n.id === 'cust') && n.animTimer > 0) {
                const frame = Math.floor(n.animTimer / 10) % 2;
                currentSprite = (frame === 0) ? SPRITE_FEMALE_WALK1 : SPRITE_FEMALE_WALK2;
                bounce = (frame === 0) ? 0 : -1;
            }
            return {...n, isNpc:true, drawSprite: currentSprite, bounce};
        });

        let playerSprite = SPRITE_PLAYER_STAND;
        let playerBounce = 0;
        if (player.animTimer > 0) {
            const frame = Math.floor(player.animTimer / 10) % 2;
            playerSprite = (frame === 0) ? SPRITE_PLAYER_WALK1 : SPRITE_PLAYER_WALK2;
            playerBounce = (frame === 0) ? 0 : -1;
        }
        renderList.push({ x: player.x, y: player.y + (player.jumpY || 0), type: 'player', drawSprite: playerSprite, colors: player.colors, bounce: playerBounce });


        const counter = SCENE.furniture.find(f=>f.type==='counter'); renderList.push({ y: counter.y + 10, type: 'counter_render', obj: counter });
        if(SCENE.cakeObj) renderList.push({ ...SCENE.cakeObj, type:'cake_render', y: SCENE.cakeObj.y+4 }); 

        renderList.sort((a,b) => a.y - b.y);

        renderList.forEach(item => {
            if(item.type === 'counter_render') {
                const c = item.obj; ctx.fillStyle = P.wood; ctx.fillRect(c.x, c.y+12, c.w, 8); ctx.fillStyle = P.glass; ctx.fillRect(c.x, c.y, c.w, 18);
                ctx.fillStyle = '#FFD54F'; ctx.fillRect(c.x+20, c.y+8, 10, 5); ctx.fillStyle = '#F48FB1'; ctx.fillRect(c.x+45, c.y+8, 10, 5); ctx.fillStyle = '#795548'; ctx.fillRect(c.x+70, c.y+8, 10, 5);
                ctx.fillStyle = 'rgba(255,255,255,0.3)'; ctx.fillRect(c.x, c.y+2, c.w, 2);
            } else if (item.type === 'cake_render') {
                drawCake(item.x, item.y);
                        } else {
                drawSprite(item.drawSprite, item.x, item.y, item.colors, item.bounce || 0);

                                // =========== ã€ä¿®æ”¹ä»£ç ã€‘åŒºåˆ†æ±¤æ±¤å’ŒCherishçš„å¸½å­é¢œè‰² ===========
                if (item.id === 'gf' || item.id === 'cherish') {
                    // è·å–å½“å‰ç»˜åˆ¶åæ ‡ï¼ŒåŒ…å«èµ°è·¯æ—¶çš„å¼¹è·³(bounce)
                    const hx = Math.floor(item.x);
                    const hy = Math.floor(item.y + (item.bounce || 0));

                    // --- æ ¸å¿ƒä¿®æ”¹ï¼šåœ¨è¿™é‡ŒåŒºåˆ†é¢œè‰² ---
                    if (item.id === 'gf') {
                        ctx.fillStyle = '#FFC610'; // æ±¤æ±¤ï¼šé»„è‰²
                    } else {
                        ctx.fillStyle = '#BA3232'; // Cherishï¼šçº¢è‰² (ä½ å¯ä»¥ä¿®æ”¹è¿™é‡Œçš„é¢œè‰²ä»£ç )
                    }
                    
                    // 1. ç»˜åˆ¶å¸½æª
                    ctx.fillRect(hx + 3, hy - 1, 8, 2); 

                    // 2. ç»˜åˆ¶å¸½é¡¶
                    ctx.fillRect(hx + 4, hy - 2, 6, 1);
                }
                // =========================================================


                if (item.hasCake) drawCake(item.x+4, item.y+8 + (item.bounce||0));
                
                if(GAME.mode === 'PLAYING' && item.isNpc) {

                    let iconType = null;
                    if (!GAME.stats.talkedNpcs.has(item.id) || (item.id === 'cust' && GAME.stats.miniGameWon && !GAME.stats.hiddenSecretRead)) iconType = '!';
                    if (item.id === 'gf' && GAME.stats.allTasksDone) iconType = 'heart';
                    
                    if(iconType) {
                        const offset = Math.floor(Date.now()/300)%2;
                        if(iconType === '!') { ctx.fillStyle = '#FFD54F'; ctx.fillRect(item.x+6, item.y-6-offset, 2, 4); ctx.fillRect(item.x+6, item.y-1-offset, 2, 1); } 
                        else { 
                            ctx.fillStyle = '#FF5252'; 
                            ctx.fillRect(item.x+3, item.y-8-offset, 2, 1); ctx.fillRect(item.x+6, item.y-8-offset, 2, 1);
                            ctx.fillRect(item.x+2, item.y-7-offset, 7, 1);
                            ctx.fillRect(item.x+2, item.y-6-offset, 7, 1);
                            ctx.fillRect(item.x+3, item.y-5-offset, 5, 1);
                            ctx.fillRect(item.x+4, item.y-4-offset, 3, 1);
                            ctx.fillRect(item.x+5, item.y-3-offset, 1, 1);
                        }
                    }
                }
            }
        });
    }
function drawBootLogo() {
  ctx.fillStyle = '#0b1c0b';
  ctx.fillRect(0, 0, 200, 150);

  ctx.fillStyle = '#9bbc0f';
  ctx.font = 'bold 16px Courier New';
  ctx.textAlign = 'center';

  // === é‡åŠ›ä¸‹è½ ===
  if (!SYSTEM.logoLanded) {
    SYSTEM.logoVy += 0.8;           // é‡åŠ›
    SYSTEM.logoY += SYSTEM.logoVy;

    if (SYSTEM.logoY >= 60) {
      SYSTEM.logoY = 60;
      SYSTEM.logoVy *= -0.25;      // å›å¼¹
      SYSTEM.logoLanded = true;

      playBootClick();             // è½åœ°éŸ³
    }
  }

  ctx.fillText('SPOON', 100, SYSTEM.logoY);
  ctx.fillText('GELATOâ„¢', 100, SYSTEM.logoY + 18);
}

function drawTitleScreen() {
  ctx.fillStyle = '#0b1c0b';
  ctx.fillRect(0, 0, 200, 150);

  // === æ»šåŠ¨é›ªæ™¯èƒŒæ™¯ ===
  ctx.fillStyle = '#ffffff';
  titleSnowflakes.forEach(p => {
    p.y += p.speed;
    if (p.y > 150) {
      p.y = 0;
      p.x = Math.random() * 200;
    }
    ctx.fillRect(Math.floor(p.x), Math.floor(p.y), 2, 2);
  });

  // === æ ‡é¢˜æ–‡å­— ===
  ctx.fillStyle = '#9bbc0f';
  ctx.font = 'bold 14px Courier New';
  ctx.textAlign = 'center';
  ctx.fillText('WINTER GELATO SHOP', 100, 45);

  ctx.font = '10px Courier New';

  SYSTEM.blink++;
  if (Math.floor(SYSTEM.blink / 30) % 2 === 0) {
    ctx.fillText('PRESS START', 100, 90);
  }
}


    function draw() {

        ctx.clearRect(0, 0, 200, 150);
// ã€ä¿®æ”¹ 2ã€‘ç»˜åˆ¶å¸½å­é€‰æ‹©ç•Œé¢
        // ==========================================
        if (GAME.mode === 'HAT_SELECT') {
            // 1. æ·±è‰²èƒŒæ™¯
            ctx.fillStyle = '#111'; 
            ctx.fillRect(0, 0, 200, 150);
            
            // 2. æ ‡é¢˜
            drawText("SELECT HAT COLOR", 100, 30, '#fff', 'center');

            // 3. é¢„è§ˆæ–¹å— (ä¸»è§’çš„å¸½å­)
            const boxSize = 20;
            const cx = 100 - boxSize/2;
            const cy = 65;
            
            // ç”»ä¸€ä¸ªå°äººè½®å»“ç¤ºæ„
            ctx.fillStyle = player.colors[1]; // å¤´å‘
            ctx.fillRect(cx+2, cy+4, 16, 16);
            ctx.fillStyle = player.colors[2]; // è„¸
            ctx.fillRect(cx+4, cy+8, 12, 10);
            
            // ç”»å½“å‰é€‰ä¸­çš„å¸½å­é¢œè‰²
            ctx.fillStyle = GAME.hatColor;
            ctx.fillRect(cx, cy, boxSize, 6); // å¸½æª
            ctx.fillRect(cx+2, cy-4, 16, 4);  // å¸½é¡¶

            // 4. å·¦å³ç®­å¤´
            if (Math.floor(Date.now() / 400) % 2 === 0) {
                drawText("<", 60, cy+5, '#FFD54F', 'center');
                drawText(">", 140, cy+5, '#FFD54F', 'center');
            }

            // 5. å½“å‰é¢œè‰²åç§°
            drawText(GAME.hatOptions[GAME.hatIndex].name, 100, 95, GAME.hatColor, 'center');

            // 6. æç¤ºæ–‡å­—
            drawText("PRESS [A] TO START", 100, 125, '#999', 'center');
            
            return; // é˜»æ­¢ç»˜åˆ¶åé¢çš„æ¸¸æˆç”»é¢
        }
        // ==========================================
       
        if (GAME.mode === 'FINAL_SHOWCASE') {
            ctx.fillStyle = '#111'; ctx.fillRect(0,0,200,150);
            ctx.fillStyle = '#eee'; ctx.fillRect(50, 10, 100, 120);
            ctx.fillStyle = '#222'; ctx.fillRect(55, 15, 90, 90);
            
            ctx.save();
            ctx.translate(55, 15);
            ctx.scale(90/200, 90/150); 
            drawScene(); 
            ctx.restore();

            if(Math.floor(Date.now()/600)%2===0) {
                drawText("[PRESS SPACE TO REPLAY]", 30, 140, '#fff');
            }
            return;
        }
 // --- ä¿®æ”¹å¼€å§‹ï¼šåº”ç”¨å±å¹•éœ‡åŠ¨ ---
        ctx.save(); // ä¿å­˜å½“å‰ç”»å¸ƒçŠ¶æ€
        if (GAME.screenShake > 0) {
            const dx = (Math.random() - 0.5) * GAME.screenShake;
            const dy = (Math.random() - 0.5) * GAME.screenShake;
            ctx.translate(dx, dy); // åç§»ç”»å¸ƒ
        }
        
        drawScene(); // ç»˜åˆ¶åœºæ™¯
        
           
   // ==========================================
        // ã€æ–°å¢åŠŸèƒ½ 1ã€‘ç»˜åˆ¶æš–å…‰é®ç½©
        // ==========================================
        if (GAME.stats.cards > 0) {
            // æ ¹æ®æ”¶é›†æ•°é‡è®¡ç®—æš–åº¦ï¼šæ¯å¼ å¡å¢åŠ  0.1 çš„ä¸é€æ˜åº¦ (æœ€å¤§ 0.3)
            // ä½¿ç”¨æš–æ©™è‰² (255, 180, 50) æ··åˆæ¨¡å¼
            const warmthOpacity = GAME.stats.cards * 0.1; 
            
            ctx.save();
            ctx.globalCompositeOperation = 'overlay'; // å åŠ æ¨¡å¼ï¼Œè®©é¢œè‰²æ›´è‡ªç„¶èåˆ
            ctx.fillStyle = `rgba(255, 160, 60, ${warmthOpacity})`;
            ctx.fillRect(0, 0, 200, 150);
            ctx.restore();
        }

        // ==========================================
        // ã€æ–°å¢åŠŸèƒ½ 2ã€‘ç»˜åˆ¶å½©è‰²çº¸ç‰‡
        // ==========================================
        if (GAME.confetti && GAME.confetti.length > 0) {
            GAME.confetti.forEach(p => {
                ctx.fillStyle = p.color;
                ctx.fillRect(Math.floor(p.x), Math.floor(p.y), 2, 2); // 2x2 åƒç´ çš„çº¸ç‰‡
            });
        }

        ctx.restore(); // æ¢å¤ç”»å¸ƒçŠ¶æ€ (éœ‡åŠ¨ç»“æŸ)
        
        GAME.vfx.forEach(item => {
            let vx = Math.floor(item.x);
            let vy = Math.floor(item.y + item.offset);

            if(item.type === 'envelope') {
                ctx.fillStyle = '#FFF'; 
                ctx.fillRect(vx, vy, 8, 5); 
                ctx.fillStyle = '#DDD'; 
                ctx.fillRect(vx, vy, 8, 1); ctx.fillRect(vx, vy+4, 8, 1); ctx.fillRect(vx, vy, 1, 5); ctx.fillRect(vx+7, vy, 1, 5);
                ctx.fillStyle = '#FF5252'; 
                ctx.fillRect(vx+3, vy+2, 2, 1);
            } else {
                ctx.fillStyle = '#FFF'; ctx.fillRect(vx, vy, 7, 7);
                ctx.fillStyle = (item.type==='note'?'#448AFF':'#FF5252'); 
                if(item.type==='note') { ctx.fillRect(vx+2, vy+1, 1, 4); ctx.fillRect(vx+3, vy+1, 2, 1); ctx.fillRect(vx+5, vy+2, 1, 1); }
            }
        });
        
        if (GAME.toast.timer > 0) {
            drawText(GAME.toast.text, 100, 135, '#fff', 'center');
        }

        if(GAME.mode === 'DIALOG') {
            drawBox(10, 110, 180, 35);
            drawText(GAME.dialog.targetName + ":", 15, 118, '#FFD54F');
            drawText(GAME.dialog.displayBuffer, 15, 130, '#fff');
            if(Math.floor(Date.now()/500)%2===0) { ctx.fillStyle = '#FFD54F'; ctx.fillRect(180, 135, 4, 4); }
        }
        if(GAME.mode === 'MINIGAME') {
            ctx.fillStyle = 'rgba(0,0,0,0.5)'; ctx.fillRect(0,0,200,150);
            const mx=50, my=50, mw=100, mh=40; drawBox(mx, my, mw, mh);
            if(!GAME.miniGame.result) {
                drawText("å‰‘ç‰æŒ‘æˆ˜! [A]", mx+10, my+12); // ä¿®æ”¹æç¤ºæ–‡å­— Space -> A
                ctx.fillStyle = '#555'; ctx.fillRect(mx+10, my+25, 80, 6);
                const z = GAME.miniGame.targetZone; ctx.fillStyle = '#4CAF50'; ctx.fillRect(Math.floor(mx+10 + (z.start/100)*80), my+25, Math.floor((z.end-z.start)/100*80), 6);
                const ptrX = mx+10 + (GAME.miniGame.pos/100)*80; ctx.fillStyle = '#FF5252'; ctx.fillRect(Math.floor(ptrX)-1, my+22, 2, 12);
            } else {
                if(GAME.miniGame.result === 'SUCCESS') { 
                    drawText("æ­¢å‰‘æˆåŠŸ!", mx+25, my+20, '#4CAF50');
                } else { 
                    drawText("é£å¹çš„...", mx+25, my+20, '#FF5252');
                }
                ctx.fillRect(mx+5, my+5, 90, 2); 
            }
        }
if (GAME.mode === 'ICE_CREAM') {
  drawBox(20, 40, 160, 60);

  drawText("éšè—å£å‘³å†°æ·‡æ·‹", 30, 48, '#FFD54F');
  
  drawText(
    "è¾“å…¥ï¼š" + GAME.iceCream.input.join(' - '),
    30,
    72
  );

  drawText("â† â†’ B", 30, 86);
}

        if(GAME.mode === 'ENDING' && GAME.mode !== 'PHOTO_OP') {
            ctx.fillStyle = 'rgba(0,0,0,0.3)'; ctx.fillRect(0,0,200,150);
            drawBigText("HAPPY", 80, 40, '#FFD54F');
            drawBigText("BIRTHDAY!", 70, 55, '#FF5252');
            if(Math.floor(Date.now()/500)%2===0) {
                drawText("[PRESS A]", 75, 100); // ä¿®æ”¹æ–‡å­— Space -> A
            }
        }
        
        if(GAME.mode === 'PHOTO_OP') {
            const ph = GAME.photoOp;
            if (ph.phase === 'flash') {
                const alpha = 1 - (ph.timer / 10);
                ctx.fillStyle = `rgba(255,255,255,${alpha})`;
                ctx.fillRect(0,0,200,150);
            } 
            if (ph.phase === 'develop') {
  ctx.fillStyle = 'rgba(0,0,0,0.8)';
  ctx.fillRect(0,0,200,150);

  // ç›¸çº¸ä¸‹æ»‘
  let photoY = -120;
  if (ph.timer < 30) photoY = -120 + (ph.timer * 4);
  else photoY = 10;

  ctx.fillStyle = '#eee';
  ctx.fillRect(50, photoY, 100, 120);

  ctx.fillStyle = '#222';
  ctx.fillRect(55, photoY+5, 90, 90);

  if (photoY === 10) {
    let opacity = (ph.timer - 30) / 60;
    opacity = Math.max(0, Math.min(1, opacity));

    ctx.save();
    ctx.translate(55, photoY+5);
    ctx.scale(90/200, 90/150);
    ctx.globalAlpha = opacity;

    drawScene();   // â† åŸæœ¬ç”»ç…§ç‰‡å†…å®¹
    ctx.restore();

    // â­ã€æ–°å¢ã€‘æ‰«æçº¿å åŠ 
    ctx.save();
    ctx.translate(55, photoY+5);
    ctx.scale(90/200, 90/150);
    drawVerticalScanlines(0.12, 2);
    ctx.restore();
  }
}

        }
    }


        /* =========================================
       2. è¾“å…¥ç®¡ç†å™¨ (çº¯éœ‡åŠ¨åé¦ˆç‰ˆ)
       ========================================= */
    class InputManager {
        constructor() {
            // è·å–é¡µé¢ä¸Šæ‰€æœ‰çš„è™šæ‹ŸæŒ‰é”®å…ƒç´ 
            this.buttons = document.querySelectorAll('.zone, .ab-btn, .pill-btn');
            this.initListeners();
        }

        // --- æ ¸å¿ƒä¿®æ”¹ï¼šåªè§¦å‘éœ‡åŠ¨ ---
        triggerHaptic() {
            // æ£€æµ‹æµè§ˆå™¨æ˜¯å¦æ”¯æŒéœ‡åŠ¨ API (ä¸»è¦é’ˆå¯¹ Android)
            // iOS Safari æš‚æ—¶ä¸æ”¯æŒæ­¤ APIï¼Œä¸ä¼šæŠ¥é”™ï¼Œåªæ˜¯æ²¡æ•ˆæœ
            if (typeof navigator.vibrate === 'function') {
                // éœ‡åŠ¨ 20msï¼ŒçŸ­ä¿ƒæœ‰åŠ›ï¼Œæ¨¡æ‹Ÿå¾®åŠ¨å¼€å…³æ‰‹æ„Ÿ
                navigator.vibrate(20); 
            }
        }

        initListeners() {
            // ç¦ç”¨å³é”®èœå•ï¼Œé˜²æ­¢é•¿æŒ‰å¼¹å‡ºèœå•å¹²æ‰°æ¸¸æˆ
            document.addEventListener('contextmenu', e => e.preventDefault());

            // 1. è§¦æ‘¸/é¼ æ ‡æ”¯æŒ
            this.buttons.forEach(btn => {
                const key = btn.dataset.key;
                
                const startAction = (e) => {
                    // é˜»æ­¢é»˜è®¤è¡Œä¸ºï¼ˆå¦‚æ»šåŠ¨ã€åŒå‡»ç¼©æ”¾ã€é«˜äº®é€‰åŒºï¼‰
                    if (e.cancelable) e.preventDefault(); 
                    
                    // >>> è§¦å‘éœ‡åŠ¨ <<<
                    this.triggerHaptic();
                    
                    // è§†è§‰æ•ˆæœï¼šæŒ‰é”®å˜æ·±è‰²
                    this.visualPress(btn, true);
                    // é€»è¾‘æ•ˆæœï¼šé€šçŸ¥æ¸¸æˆå¼•æ“
                    this.triggerGameInput(key, true); 
                };

                const endAction = (e) => {
                    if (e.cancelable) e.preventDefault();
                    this.visualPress(btn, false);
                    this.triggerGameInput(key, false);
                };

                // 'passive: false' æ˜¯å¿…é¡»çš„ï¼Œå¦åˆ™æ— æ³•è°ƒç”¨ preventDefault é˜»æ­¢æ»šåŠ¨
                btn.addEventListener('touchstart', startAction, { passive: false });
                btn.addEventListener('mousedown', startAction);
                
                btn.addEventListener('touchend', endAction);
                btn.addEventListener('mouseup', endAction);
                btn.addEventListener('mouseleave', endAction);
            });

            // 2. ç‰©ç†é”®ç›˜æ”¯æŒ (PCè°ƒè¯•ç”¨)
            window.addEventListener('keydown', (e) => {
                if(e.repeat) return; 
                
                // æ˜ å°„ç‰©ç†æŒ‰é”®åˆ°è™šæ‹ŸæŒ‰é”®çš„è§†è§‰æ•ˆæœ
                let visualKey = this.mapPhysicalToVirtual(e.key);
                const btn = document.querySelector(`[data-key="${visualKey}"]`);
                
                if(btn) this.visualPress(btn, true);

                this.handlePhysicalKey(e.key, true);
            });

            window.addEventListener('keyup', (e) => {
                let visualKey = this.mapPhysicalToVirtual(e.key);
                const btn = document.querySelector(`[data-key="${visualKey}"]`);
                
                if(btn) this.visualPress(btn, false);

                this.handlePhysicalKey(e.key, false);
            });
        }

        // è¾…åŠ©ï¼šæ˜ å°„ç‰©ç†æŒ‰é”®ååˆ° data-key å±æ€§
        mapPhysicalToVirtual(key) {
            if(key === ' ') return ' ';
            if(key.toLowerCase() === 'z') return 'z';
            if(key === 'ArrowUp') return 'ArrowUp';
            if(key === 'ArrowDown') return 'ArrowDown';
            if(key === 'ArrowLeft') return 'ArrowLeft';
            if(key === 'ArrowRight') return 'ArrowRight';
            return key;
        }

        // å¤„ç†ç‰©ç†é”®ç›˜é€»è¾‘
        handlePhysicalKey(key, isPressed) {
            const k = key.toLowerCase();
            if(k === 'w' || k === 'arrowup') this.triggerGameInput('ArrowUp', isPressed);
            if(k === 's' || k === 'arrowdown') this.triggerGameInput('ArrowDown', isPressed);
            if(k === 'a' || k === 'arrowleft') this.triggerGameInput('ArrowLeft', isPressed);
            if(k === 'd' || k === 'arrowright') this.triggerGameInput('ArrowRight', isPressed);
            if(k === ' ' || k === 'enter') this.triggerGameInput(' ', isPressed); // Starté”®
            if(k === 'z') this.triggerGameInput('z', isPressed); // Aé”®
            if(k === 'x') this.triggerGameInput('x', isPressed); // Bé”®(å¦‚æœæœ‰)
if(k === 'shift') this.triggerGameInput('Shift', isPressed);
        }

        triggerGameInput(virtualKey, isPressed) {
 // ã€ä¿®æ”¹ 3ã€‘å¸½å­é€‰æ‹©æ¨¡å¼çš„è¾“å…¥æ§åˆ¶
            // ==========================================
            if (GAME.mode === 'HAT_SELECT' && isPressed) {
                // 1. å·¦å³åˆ‡æ¢
                if (virtualKey === 'ArrowRight' || virtualKey === 'ArrowLeft') {
                    const dir = (virtualKey === 'ArrowRight') ? 1 : -1;
                    // å¾ªç¯åˆ‡æ¢é€»è¾‘
                    GAME.hatIndex = (GAME.hatIndex + dir + GAME.hatOptions.length) % GAME.hatOptions.length;
                    
                    // æ›´æ–°ä¸´æ—¶é¢œè‰²
                    GAME.hatColor = GAME.hatOptions[GAME.hatIndex].hex;
                    
                    // æ’­æ”¾éŸ³æ•ˆ (ç›´æ¥è°ƒç”¨ä½ ç°æœ‰çš„å‡½æ•°)
                    if(typeof playTone === 'function') playTone(600, 0.05, 'square', 0.1);
                }

                // 2. ç¡®è®¤é€‰æ‹© (Zé”®=Aé”®, ç©ºæ ¼=Start, å›è½¦=Start)
                if (virtualKey === 'z' || virtualKey === ' ' || virtualKey === 'Enter') {
                    // åº”ç”¨é¢œè‰²åˆ°ä¸»è§’èº«ä¸Š (player.colors[4] æ˜¯åŸæœ¬çº¢è‰²çš„éƒ¨ä½)
                    player.colors[4] = GAME.hatColor;
                    
                    // è¿›å…¥æ¸¸æˆ
                    GAME.mode = 'PLAYING';
                    
                    // æ’­æ”¾ç¡®è®¤éŸ³æ•ˆ
                    if(typeof playTone === 'function') {
                        playTone(880, 0.1, 'square', 0.1);
                        setTimeout(() => playTone(1100, 0.2, 'square', 0.1), 100);
                    }
                }
                return; // é˜»æ­¢åç»­é€»è¾‘
            }
            // ==========================================

            // å°†è¾“å…¥æ˜ å°„åˆ°å…¨å±€ keys å¯¹è±¡
            if(virtualKey === 'ArrowUp')    keys.w = isPressed;
            if(virtualKey === 'ArrowDown')  keys.s = isPressed;
            if(virtualKey === 'ArrowLeft')  keys.a = isPressed;
            if(virtualKey === 'ArrowRight') keys.d = isPressed;
            
            // å¤„ç†äº¤äº’é”® (Start/Aé”®)
            if(virtualKey === ' ' && isPressed) {
                if(typeof handleInteraction === 'function') handleInteraction();
            }

            // ==================================================
            // ã€æ–°å¢ã€‘SELECT é”® (Shift) åˆ‡æ¢éš¾åº¦
            // ==================================================
            if (virtualKey === 'Shift' && isPressed) {
                if (GAME && GAME.miniGame) {
                    // 1. åˆ‡æ¢çŠ¶æ€
                    const isNormal = (GAME.miniGame.difficulty === 'NORMAL');
                    GAME.miniGame.difficulty = isNormal ? 'EASY' : 'NORMAL';

                    // 2. åº”ç”¨å‚æ•°
                    if (GAME.miniGame.difficulty === 'EASY') {
                        GAME.miniGame.speed = 1.5;         // ç®€å•ï¼šæ…¢é€Ÿ
                        GAME.miniGame.targetZone = { start: 30, end: 70 }; // ç®€å•ï¼šå¤§åˆ¤å®šåŒº
                        GAME.toast.text = "éš¾åº¦: ç®€å• (EASY)";
                        // æ’­æ”¾ä½æ²‰æç¤ºéŸ³
                        if(typeof playTone === 'function') playTone(600, 0.1, 'square', 0.1);
                    } else {
                        GAME.miniGame.speed = 2.5;         // æ­£å¸¸ï¼šå¿«é€Ÿ
                        GAME.miniGame.targetZone = { start: 42, end: 58 }; // æ­£å¸¸ï¼šå°åˆ¤å®šåŒº
                        GAME.toast.text = "éš¾åº¦: æ­£å¸¸ (NORMAL)";
                        // æ’­æ”¾æ¸…è„†æç¤ºéŸ³
                        if(typeof playTone === 'function') playTone(800, 0.1, 'square', 0.1);
                    }
                    GAME.toast.timer = 60;
                }
            }
            // ==================================================

            // === å†°æ·‡æ·‹åˆ¶ä½œè¾“å…¥é€»è¾‘ (ä¿æŒä¸å˜) ===
            if (GAME.mode === 'ICE_CREAM' && isPressed) {
                if (['ArrowUp','ArrowDown','ArrowLeft','ArrowRight'].includes(virtualKey)) {
                    GAME.iceCream.input.push(virtualKey);
                }
                // A é”®ï¼ˆä½ è¿™é‡Œæ˜¯ zï¼‰
                if (virtualKey === 'z') {
                    GAME.iceCream.input.push('A');
                    checkIceCreamResult();
                }
            }
        }

        visualPress(element, isPressed) {
            if (isPressed) element.classList.add('btn-active');
            else element.classList.remove('btn-active');
        }
    }



    new InputManager();


    /* =========================================
       3. è§†å£é€‚é…å™¨ (Viewport Adapter)
       ========================================= */
    function resizeGameBoy() {
        const container = document.getElementById('gameboy-container');
        const windowWidth = window.innerWidth;
        const windowHeight = window.innerHeight;
        const baseWidth = 320; 
        const baseHeight = 540;
        const margin = 20;
        const scaleX = (windowWidth - margin) / baseWidth;
        const scaleY = (windowHeight - margin) / baseHeight;
        let scale = Math.min(scaleX, scaleY);
        if (scale > 1.2) scale = 1.2; // ç¨å¾®é™åˆ¶æœ€å¤§å€æ•°
        container.style.transform = `scale(${scale})`;
    }

    window.addEventListener('resize', resizeGameBoy);
    resizeGameBoy();
   function loop() {
  ctx.clearRect(0, 0, 200, 150);

  // ====== å¼€æœº LOGO ======
  if (SYSTEM.state === 'LOGO') {
    drawBootLogo();
    SYSTEM.timer++;
    if (SYSTEM.timer > 120) {
      SYSTEM.state = 'TITLE';
      SYSTEM.timer = 0;
    }
    requestAnimationFrame(loop);
    return;
  }

  // ====== Title Screen ======
  if (SYSTEM.state === 'TITLE') {
    drawTitleScreen();
    requestAnimationFrame(loop);
    return;
  }

  // ====== æ­£å¼æ¸¸æˆ ======
  update();
  draw();
  requestAnimationFrame(loop);
}

loop();


</script>
</body>
</html>
